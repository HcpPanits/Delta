<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة شركة الدهانات</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Sweet Alert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#5D5CDE',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                        },
                    },
                },
            },
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-color: #5D5CDE;
            --primary-light: #818cf8;
            --primary-dark: #4338ca;
            --text-color: #333;
            --text-light: #666;
            --bg-color: #fff;
            --bg-secondary: #f9fafb;
            --border-color: #e5e7eb;
        }
        
        .dark {
            --text-color: #f9fafb;
            --text-light: #d1d5db;
            --bg-color: #181818;
            --bg-secondary: #1f2937;
            --border-color: #374151;
        }
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
        }

        /* Animation for loading */
        .loader {
            border-top-color: var(--primary-color);
            animation: spinner 1.5s linear infinite;
        }
        
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Sidebar transition */
        .sidebar-transition {
            transition: all 0.3s ease-in-out;
        }
        
        /* Form styling */
        .form-input {
            @apply block w-full px-4 py-2 mt-1 text-gray-900 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-800 dark:text-white dark:border-gray-600;
            font-size: 16px;
        }
        
        .form-select {
            @apply block w-full px-4 py-2 mt-1 text-gray-900 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-800 dark:text-white dark:border-gray-600;
            font-size: 16px;
        }
        
        .btn {
            @apply px-4 py-2 text-sm font-medium text-white transition-colors duration-150 border border-transparent rounded-md focus:outline-none;
            font-size: 16px;
        }
        
        .btn-primary {
            @apply bg-primary-500 hover:bg-primary-600 active:bg-primary-700;
        }
        
        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-600 active:bg-gray-700;
        }
        
        .btn-danger {
            @apply bg-red-500 hover:bg-red-600 active:bg-red-700;
        }
        
        .btn-success {
            @apply bg-green-500 hover:bg-green-600 active:bg-green-700;
        }
        
        .card {
            @apply bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden;
        }
        
        .table-container {
            @apply w-full overflow-x-auto;
        }
        
        .table {
            @apply min-w-full divide-y divide-gray-200 dark:divide-gray-700;
        }
        
        .table th {
            @apply px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400;
        }
        
        .table td {
            @apply px-6 py-4 whitespace-nowrap text-sm dark:text-gray-300;
        }
        
        .table tr {
            @apply bg-white dark:bg-gray-800;
        }
        
        .table tr:nth-child(even) {
            @apply bg-gray-50 dark:bg-gray-700;
        }
        
        .badge {
            @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
        }
        
        .badge-primary {
            @apply bg-primary-100 text-primary-800 dark:bg-primary-900 dark:text-primary-300;
        }
        
        .badge-success {
            @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300;
        }
        
        .badge-warning {
            @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300;
        }
        
        .badge-danger {
            @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 card p-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900 dark:text-white">
                    تسجيل الدخول
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">
                    نظام إدارة شركة الدهانات
                </p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email" class="sr-only">البريد الإلكتروني</label>
                        <input id="email" name="email" type="email" autocomplete="email" required class="form-input rounded-t-md" placeholder="البريد الإلكتروني">
                    </div>
                    <div>
                        <label for="password" class="sr-only">كلمة المرور</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="form-input rounded-b-md" placeholder="كلمة المرور">
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                        <label for="remember-me" class="mr-2 block text-sm text-gray-900 dark:text-gray-300">
                            تذكرني
                        </label>
                    </div>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center btn btn-primary">
                        <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                            <i class="fas fa-sign-in-alt"></i>
                        </span>
                        تسجيل الدخول
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden h-screen flex flex-col">
        <!-- Top Navbar -->
        <header class="bg-white dark:bg-gray-800 shadow-sm z-10">
            <div class="flex justify-between items-center px-4 py-3">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="text-gray-500 focus:outline-none focus:text-gray-700 md:hidden">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="text-lg md:text-xl font-bold text-gray-800 dark:text-white mr-3">نظام إدارة شركة الدهانات</h1>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="relative">
                        <button id="theme-toggle" class="text-gray-500 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-200">
                            <i class="fas fa-moon dark:hidden"></i>
                            <i class="fas fa-sun hidden dark:block"></i>
                        </button>
                    </div>
                    <div class="relative">
                        <button id="user-menu-button" class="flex items-center text-sm rounded-full focus:outline-none">
                            <span id="user-name" class="hidden md:block ml-2 text-gray-700 dark:text-gray-300"></span>
                            <div class="h-8 w-8 rounded-full bg-primary-500 flex items-center justify-center text-white">
                                <i class="fas fa-user"></i>
                            </div>
                        </button>
                        <div id="user-dropdown" class="hidden origin-top-right absolute left-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu">
                            <div class="block px-4 py-2 text-xs text-gray-400">
                                الإعدادات
                            </div>
                            <a href="#" id="profile-link" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                                <i class="fas fa-user-circle ml-2"></i>
                                الملف الشخصي
                            </a>
                            <div class="border-t border-gray-100 dark:border-gray-700"></div>
                            <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                                <i class="fas fa-sign-out-alt ml-2"></i>
                                تسجيل الخروج
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <aside id="sidebar" class="bg-white dark:bg-gray-800 w-64 hidden md:block shadow-md sidebar-transition overflow-y-auto">
                <div class="py-4">
                    <nav>
                        <ul>
                            <li>
                                <a href="#dashboard" class="nav-link" data-page="dashboard">
                                    <i class="fas fa-tachometer-alt ml-2"></i>
                                    لوحة التحكم
                                </a>
                            </li>
                            <li>
                                <a href="#products" class="nav-link" data-page="products">
                                    <i class="fas fa-paint-roller ml-2"></i>
                                    إدارة المنتجات
                                </a>
                            </li>
                            <li>
                                <a href="#clients" class="nav-link" data-page="clients">
                                    <i class="fas fa-users ml-2"></i>
                                    إدارة العملاء
                                </a>
                            </li>
                            <li>
                                <a href="#orders" class="nav-link" data-page="orders">
                                    <i class="fas fa-shopping-cart ml-2"></i>
                                    الطلبات
                                </a>
                            </li>
                            <li>
                                <a href="#invoices" class="nav-link" data-page="invoices">
                                    <i class="fas fa-file-invoice-dollar ml-2"></i>
                                    الفواتير
                                </a>
                            </li>
                            <li>
                                <a href="#payments" class="nav-link" data-page="payments">
                                    <i class="fas fa-money-bill-wave ml-2"></i>
                                    سداد العملاء
                                </a>
                            </li>
                            <li>
                                <a href="#account-statement" class="nav-link" data-page="account-statement">
                                    <i class="fas fa-file-alt ml-2"></i>
                                    كشف حساب العملاء
                                </a>
                            </li>
                            <li>
                                <a href="#returns" class="nav-link" data-page="returns">
                                    <i class="fas fa-undo ml-2"></i>
                                    المرتجعات
                                </a>
                            </li>
                            <li id="admin-menu" class="hidden">
                                <a href="#users" class="nav-link" data-page="users">
                                    <i class="fas fa-user-cog ml-2"></i>
                                    إدارة المستخدمين
                                </a>
                            </li>
                            <li id="reports-menu">
                                <a href="#reports" class="nav-link" data-page="reports">
                                    <i class="fas fa-chart-bar ml-2"></i>
                                    التقارير
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-900 p-4">
                <!-- Dashboard -->
                <div id="dashboard-page" class="page">
                    <h2 class="text-2xl font-bold mb-6">لوحة التحكم</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 flex items-center">
                            <div class="p-3 rounded-full bg-primary-100 dark:bg-primary-900 text-primary-500 ml-4">
                                <i class="fas fa-shopping-cart text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 dark:text-gray-400 text-sm">إجمالي الطلبات</p>
                                <p id="total-orders" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 flex items-center">
                            <div class="p-3 rounded-full bg-green-100 dark:bg-green-900 text-green-500 ml-4">
                                <i class="fas fa-money-bill-wave text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 dark:text-gray-400 text-sm">إجمالي المبيعات</p>
                                <p id="total-sales" class="text-2xl font-bold text-gray-900 dark:text-white">0 ج.م</p>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-500 ml-4">
                                <i class="fas fa-users text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 dark:text-gray-400 text-sm">إجمالي العملاء</p>
                                <p id="total-clients" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 dark:bg-yellow-900 text-yellow-500 ml-4">
                                <i class="fas fa-paint-roller text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 dark:text-gray-400 text-sm">إجمالي المنتجات</p>
                                <p id="total-products" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">إحصائيات المبيعات</h3>
                            <div class="h-80">
                                <canvas id="sales-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">أعلى المنتجات مبيعًا</h3>
                            <div class="h-80">
                                <canvas id="products-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Products Management -->
                <div id="products-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h2 class="text-2xl font-bold">إدارة المنتجات</h2>
                        <button id="add-product-btn" class="btn btn-primary mt-3 md:mt-0">
                            <i class="fas fa-plus ml-1"></i>
                            إضافة منتج جديد
                        </button>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="w-full md:w-1/3">
                                <label for="product-search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">بحث</label>
                                <input type="text" id="product-search" class="form-input" placeholder="ابحث عن منتج...">
                            </div>
                            <div class="w-full md:w-1/3">
                                <label for="product-category-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">التصنيف</label>
                                <select id="product-category-filter" class="form-select">
                                    <option value="">كل التصنيفات</option>
                                    <option value="انشائي">انشائي</option>
                                    <option value="واجهات خارجية">واجهات خارجية</option>
                                    <option value="ديكوري">ديكوري</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col">كود المنتج</th>
                                        <th scope="col">اسم المنتج</th>
                                        <th scope="col">التصنيف</th>
                                        <th scope="col">اللون/الباتش</th>
                                        <th scope="col">السعر</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table-body">
                                    <!-- Products will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="products-empty-state" class="text-center py-8 hidden">
                            <i class="fas fa-paint-roller text-gray-400 text-5xl mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">لم يتم إضافة أي منتجات بعد.</p>
                            <button id="empty-add-product-btn" class="btn btn-primary mt-4">
                                <i class="fas fa-plus ml-1"></i>
                                إضافة منتج جديد
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Clients Management -->
                <div id="clients-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h2 class="text-2xl font-bold">إدارة العملاء</h2>
                        <button id="add-client-btn" class="btn btn-primary mt-3 md:mt-0">
                            <i class="fas fa-plus ml-1"></i>
                            إضافة عميل جديد
                        </button>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="w-full md:w-1/3">
                                <label for="client-search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">بحث</label>
                                <input type="text" id="client-search" class="form-input" placeholder="ابحث عن عميل...">
                            </div>
                            <div class="w-full md:w-1/3">
                                <label for="client-type-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">التصنيف</label>
                                <select id="client-type-filter" class="form-select">
                                    <option value="">كل العملاء</option>
                                    <option value="هيئات/مشاريع">هيئات/مشاريع</option>
                                    <option value="محلات">محلات</option>
                                    <option value="اهالى">اهالى</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col">كود العميل</th>
                                        <th scope="col">اسم العميل</th>
                                        <th scope="col">رقم الهاتف</th>
                                        <th scope="col">التصنيف</th>
                                        <th scope="col">نسبة الخصم</th>
                                        <th scope="col">الرصيد</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="clients-table-body">
                                    <!-- Clients will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="clients-empty-state" class="text-center py-8 hidden">
                            <i class="fas fa-users text-gray-400 text-5xl mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">لم يتم إضافة أي عملاء بعد.</p>
                            <button id="empty-add-client-btn" class="btn btn-primary mt-4">
                                <i class="fas fa-plus ml-1"></i>
                                إضافة عميل جديد
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Orders Management -->
                <div id="orders-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h2 class="text-2xl font-bold">إدارة الطلبات</h2>
                        <button id="add-order-btn" class="btn btn-primary mt-3 md:mt-0">
                            <i class="fas fa-plus ml-1"></i>
                            إنشاء طلب جديد
                        </button>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="w-full md:w-1/4">
                                <label for="order-search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">بحث</label>
                                <input type="text" id="order-search" class="form-input" placeholder="رقم الطلب أو اسم العميل...">
                            </div>
                            <div class="w-full md:w-1/4">
                                <label for="order-status-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الحالة</label>
                                <select id="order-status-filter" class="form-select">
                                    <option value="">كل الطلبات</option>
                                    <option value="pending">قيد الانتظار</option>
                                    <option value="completed">مكتمل</option>
                                    <option value="cancelled">ملغي</option>
                                </select>
                            </div>
                            <div class="w-full md:w-1/4">
                                <label for="order-date-from" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">من تاريخ</label>
                                <input type="date" id="order-date-from" class="form-input">
                            </div>
                            <div class="w-full md:w-1/4">
                                <label for="order-date-to" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">إلى تاريخ</label>
                                <input type="date" id="order-date-to" class="form-input">
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col">رقم الطلب</th>
                                        <th scope="col">التاريخ</th>
                                        <th scope="col">العميل</th>
                                        <th scope="col">الإجمالي</th>
                                        <th scope="col">طريقة الدفع</th>
                                        <th scope="col">الحالة</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table-body">
                                    <!-- Orders will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="orders-empty-state" class="text-center py-8 hidden">
                            <i class="fas fa-shopping-cart text-gray-400 text-5xl mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">لم يتم إنشاء أي طلبات بعد.</p>
                            <button id="empty-add-order-btn" class="btn btn-primary mt-4">
                                <i class="fas fa-plus ml-1"></i>
                                إنشاء طلب جديد
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Invoices Page -->
                <div id="invoices-page" class="page hidden">
                    <h2 class="text-2xl font-bold mb-6">عرض الفواتير</h2>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="w-full md:w-1/4">
                                <label for="invoice-search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">بحث</label>
                                <input type="text" id="invoice-search" class="form-input" placeholder="رقم الفاتورة أو اسم العميل...">
                            </div>
                            <div class="w-full md:w-1/4">
                                <label for="invoice-date-from" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">من تاريخ</label>
                                <input type="date" id="invoice-date-from" class="form-input">
                            </div>
                            <div class="w-full md:w-1/4">
                                <label for="invoice-date-to" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">إلى تاريخ</label>
                                <input type="date" id="invoice-date-to" class="form-input">
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col">رقم الفاتورة</th>
                                        <th scope="col">رقم الطلب</th>
                                        <th scope="col">التاريخ</th>
                                        <th scope="col">العميل</th>
                                        <th scope="col">الإجمالي</th>
                                        <th scope="col">حالة الدفع</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoices-table-body">
                                    <!-- Invoices will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Payments Page -->
                <div id="payments-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h2 class="text-2xl font-bold">سداد العملاء</h2>
                        <button id="add-payment-btn" class="btn btn-primary mt-3 md:mt-0">
                            <i class="fas fa-plus ml-1"></i>
                            إضافة سداد جديد
                        </button>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="w-full md:w-1/3">
                                <label for="payment-client-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">العميل</label>
                                <select id="payment-client-filter" class="form-select">
                                    <option value="">كل العملاء</option>
                                    <!-- Clients will be dynamically inserted here -->
                                </select>
                            </div>
                            <div class="w-full md:w-1/3">
                                <label for="payment-date-from" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">من تاريخ</label>
                                <input type="date" id="payment-date-from" class="form-input">
                            </div>
                            <div class="w-full md:w-1/3">
                                <label for="payment-date-to" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">إلى تاريخ</label>
                                <input type="date" id="payment-date-to" class="form-input">
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col">رقم السداد</th>
                                        <th scope="col">التاريخ</th>
                                        <th scope="col">العميل</th>
                                        <th scope="col">المبلغ</th>
                                        <th scope="col">طريقة السداد</th>
                                        <th scope="col">ملاحظات</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="payments-table-body">
                                    <!-- Payments will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="payments-empty-state" class="text-center py-8 hidden">
                            <i class="fas fa-money-bill-wave text-gray-400 text-5xl mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">لم يتم تسجيل أي عمليات سداد بعد.</p>
                            <button id="empty-add-payment-btn" class="btn btn-primary mt-4">
                                <i class="fas fa-plus ml-1"></i>
                                إضافة سداد جديد
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Account Statement Page -->
                <div id="account-statement-page" class="page hidden">
                    <h2 class="text-2xl font-bold mb-6">كشف حساب العملاء</h2>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="w-full md:w-1/3">
                                <label for="statement-client" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">العميل</label>
                                <select id="statement-client" class="form-select" required>
                                    <option value="">اختر العميل</option>
                                    <!-- Clients will be dynamically inserted here -->
                                </select>
                            </div>
                            <div class="w-full md:w-1/3">
                                <label for="statement-date-from" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">من تاريخ</label>
                                <input type="date" id="statement-date-from" class="form-input">
                            </div>
                            <div class="w-full md:w-1/3">
                                <label for="statement-date-to" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">إلى تاريخ</label>
                                <input type="date" id="statement-date-to" class="form-input">
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button id="generate-statement-btn" class="btn btn-primary">
                                <i class="fas fa-search ml-1"></i>
                                عرض كشف الحساب
                            </button>
                        </div>
                    </div>
                    
                    <div id="statement-results" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold" id="statement-title">كشف حساب: <span id="statement-client-name"></span></h3>
                            <div>
                                <button id="print-statement-btn" class="btn btn-secondary ml-2">
                                    <i class="fas fa-print ml-1"></i>
                                    طباعة
                                </button>
                                <button id="export-statement-pdf-btn" class="btn btn-primary ml-2">
                                    <i class="fas fa-file-pdf ml-1"></i>
                                    تصدير PDF
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">الفترة</p>
                                    <p id="statement-period" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">إجمالي المشتريات</p>
                                    <p id="statement-total-purchases" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">إجمالي المدفوعات</p>
                                    <p id="statement-total-payments" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">الرصيد الحالي</p>
                                    <p id="statement-current-balance" class="font-medium"></p>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th scope="col">التاريخ</th>
                                            <th scope="col">البيان</th>
                                            <th scope="col">مدين</th>
                                            <th scope="col">دائن</th>
                                            <th scope="col">الرصيد</th>
                                        </tr>
                                    </thead>
                                    <tbody id="statement-table-body">
                                        <!-- Statement data will be dynamically inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="statement-empty" class="hidden text-center py-8">
                        <i class="fas fa-file-alt text-gray-400 text-5xl mb-4"></i>
                        <p class="text-gray-500 dark:text-gray-400">يرجى اختيار عميل لعرض كشف الحساب.</p>
                    </div>
                </div>
                
                <!-- Returns Page -->
                <div id="returns-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h2 class="text-2xl font-bold">المرتجعات</h2>
                        <button id="add-return-btn" class="btn btn-primary mt-3 md:mt-0">
                            <i class="fas fa-plus ml-1"></i>
                            إضافة مرتجع جديد
                        </button>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="w-full md:w-1/3">
                                <label for="return-client-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">العميل</label>
                                <select id="return-client-filter" class="form-select">
                                    <option value="">كل العملاء</option>
                                    <!-- Clients will be dynamically inserted here -->
                                </select>
                            </div>
                            <div class="w-full md:w-1/3">
                                <label for="return-date-from" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">من تاريخ</label>
                                <input type="date" id="return-date-from" class="form-input">
                            </div>
                            <div class="w-full md:w-1/3">
                                <label for="return-date-to" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">إلى تاريخ</label>
                                <input type="date" id="return-date-to" class="form-input">
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col">رقم المرتجع</th>
                                        <th scope="col">التاريخ</th>
                                        <th scope="col">العميل</th>
                                        <th scope="col">رقم الطلب</th>
                                        <th scope="col">المبلغ</th>
                                        <th scope="col">السبب</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="returns-table-body">
                                    <!-- Returns will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="returns-empty-state" class="text-center py-8 hidden">
                            <i class="fas fa-undo text-gray-400 text-5xl mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">لم يتم تسجيل أي مرتجعات بعد.</p>
                            <button id="empty-add-return-btn" class="btn btn-primary mt-4">
                                <i class="fas fa-plus ml-1"></i>
                                إضافة مرتجع جديد
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Users Management Page (Admin only) -->
                <div id="users-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h2 class="text-2xl font-bold">إدارة المستخدمين</h2>
                        <button id="add-user-btn" class="btn btn-primary mt-3 md:mt-0">
                            <i class="fas fa-plus ml-1"></i>
                            إضافة مستخدم جديد
                        </button>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="w-full md:w-1/2">
                                <label for="user-search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">بحث</label>
                                <input type="text" id="user-search" class="form-input" placeholder="ابحث عن مستخدم...">
                            </div>
                            <div class="w-full md:w-1/2">
                                <label for="user-role-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الدور</label>
                                <select id="user-role-filter" class="form-select">
                                    <option value="">كل الأدوار</option>
                                    <option value="admin">مدير</option>
                                    <option value="supervisor">مشرف</option>
                                    <option value="user">مستخدم</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col">الاسم</th>
                                        <th scope="col">البريد الإلكتروني</th>
                                        <th scope="col">الدور</th>
                                        <th scope="col">تاريخ الإنشاء</th>
                                        <th scope="col">الحالة</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Users will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Page -->
                <div id="reports-page" class="page hidden">
                    <h2 class="text-2xl font-bold mb-6">التقارير</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">تقرير المبيعات</h3>
                            <div class="mb-4">
                                <div class="flex flex-col md:flex-row gap-4">
                                    <div class="w-full md:w-1/2">
                                        <label for="sales-report-period" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الفترة</label>
                                        <select id="sales-report-period" class="form-select">
                                            <option value="daily">يومي</option>
                                            <option value="weekly">أسبوعي</option>
                                            <option value="monthly" selected>شهري</option>
                                            <option value="yearly">سنوي</option>
                                            <option value="custom">مخصص</option>
                                        </select>
                                    </div>
                                    <div class="w-full md:w-1/2" id="sales-report-custom-date" style="display: none;">
                                        <div class="flex gap-2">
                                            <div class="w-1/2">
                                                <label for="sales-report-from" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">من</label>
                                                <input type="date" id="sales-report-from" class="form-input">
                                            </div>
                                            <div class="w-1/2">
                                                <label for="sales-report-to" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">إلى</label>
                                                <input type="date" id="sales-report-to" class="form-input">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mb-4">
                                <button id="generate-sales-report-btn" class="btn btn-primary">
                                    <i class="fas fa-sync-alt ml-1"></i>
                                    تحديث التقرير
                                </button>
                            </div>
                            <div>
                                <canvas id="sales-report-chart" height="250"></canvas>
                            </div>
                            <div class="mt-4 text-center">
                                <button id="export-sales-report-btn" class="btn btn-secondary">
                                    <i class="fas fa-file-export ml-1"></i>
                                    تصدير التقرير
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">تقرير المنتجات</h3>
                            <div class="mb-4">
                                <div class="flex flex-col md:flex-row gap-4">
                                    <div class="w-full md:w-1/2">
                                        <label for="products-report-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">التصنيف</label>
                                        <select id="products-report-category" class="form-select">
                                            <option value="">كل التصنيفات</option>
                                            <option value="انشائي">انشائي</option>
                                            <option value="واجهات خارجية">واجهات خارجية</option>
                                            <option value="ديكوري">ديكوري</option>
                                        </select>
                                    </div>
                                    <div class="w-full md:w-1/2">
                                        <label for="products-report-period" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الفترة</label>
                                        <select id="products-report-period" class="form-select">
                                            <option value="monthly" selected>شهري</option>
                                            <option value="quarterly">ربع سنوي</option>
                                            <option value="yearly">سنوي</option>
                                            <option value="all">كل الفترات</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mb-4">
                                <button id="generate-products-report-btn" class="btn btn-primary">
                                    <i class="fas fa-sync-alt ml-1"></i>
                                    تحديث التقرير
                                </button>
                            </div>
                            <div>
                                <canvas id="products-report-chart" height="250"></canvas>
                            </div>
                            <div class="mt-4 text-center">
                                <button id="export-products-report-btn" class="btn btn-secondary">
                                    <i class="fas fa-file-export ml-1"></i>
                                    تصدير التقرير
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">تقرير العملاء</h3>
                            <div class="mb-4">
                                <div class="flex flex-col md:flex-row gap-4">
                                    <div class="w-full md:w-1/2">
                                        <label for="clients-report-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">نوع التقرير</label>
                                        <select id="clients-report-type" class="form-select">
                                            <option value="top-clients">أفضل العملاء</option>
                                            <option value="client-category">العملاء حسب التصنيف</option>
                                            <option value="balances">أرصدة العملاء</option>
                                        </select>
                                    </div>
                                    <div class="w-full md:w-1/2" id="clients-report-limit-container">
                                        <label for="clients-report-limit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">عدد العملاء</label>
                                        <select id="clients-report-limit" class="form-select">
                                            <option value="5">5</option>
                                            <option value="10" selected>10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mb-4">
                                <button id="generate-clients-report-btn" class="btn btn-primary">
                                    <i class="fas fa-sync-alt ml-1"></i>
                                    تحديث التقرير
                                </button>
                            </div>
                            <div>
                                <canvas id="clients-report-chart" height="250"></canvas>
                            </div>
                            <div class="mt-4 text-center">
                                <button id="export-clients-report-btn" class="btn btn-secondary">
                                    <i class="fas fa-file-export ml-1"></i>
                                    تصدير التقرير
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">ملخص الأداء</h3>
                            <div class="mb-4">
                                <div class="flex flex-col md:flex-row gap-4">
                                    <div class="w-full md:w-1/2">
                                        <label for="performance-report-period" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الفترة</label>
                                        <select id="performance-report-period" class="form-select">
                                            <option value="this-month">الشهر الحالي</option>
                                            <option value="last-month">الشهر الماضي</option>
                                            <option value="this-quarter">الربع الحالي</option>
                                            <option value="last-quarter">الربع الماضي</option>
                                            <option value="this-year">السنة الحالية</option>
                                            <option value="last-year">السنة الماضية</option>
                                        </select>
                                    </div>
                                    <div class="w-full md:w-1/2">
                                        <label for="performance-report-comparison" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">المقارنة</label>
                                        <select id="performance-report-comparison" class="form-select">
                                            <option value="previous-period">مع الفترة السابقة</option>
                                            <option value="same-period-last-year">مع نفس الفترة العام الماضي</option>
                                            <option value="none">بدون مقارنة</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mb-4">
                                <button id="generate-performance-report-btn" class="btn btn-primary">
                                    <i class="fas fa-sync-alt ml-1"></i>
                                    تحديث التقرير
                                </button>
                            </div>
                            <div>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                        <p class="text-sm text-gray-500 dark:text-gray-400">إجمالي المبيعات</p>
                                        <p id="performance-total-sales" class="text-xl font-bold">0 ج.م</p>
                                        <p id="performance-sales-comparison" class="text-sm"></p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                        <p class="text-sm text-gray-500 dark:text-gray-400">عدد الطلبات</p>
                                        <p id="performance-total-orders" class="text-xl font-bold">0</p>
                                        <p id="performance-orders-comparison" class="text-sm"></p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                        <p class="text-sm text-gray-500 dark:text-gray-400">متوسط قيمة الطلب</p>
                                        <p id="performance-average-order" class="text-xl font-bold">0 ج.م</p>
                                        <p id="performance-average-comparison" class="text-sm"></p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                        <p class="text-sm text-gray-500 dark:text-gray-400">عدد العملاء الجدد</p>
                                        <p id="performance-new-clients" class="text-xl font-bold">0</p>
                                        <p id="performance-clients-comparison" class="text-sm"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 text-center">
                                <button id="export-performance-report-btn" class="btn btn-secondary">
                                    <i class="fas fa-file-export ml-1"></i>
                                    تصدير التقرير
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="product-modal-title" class="text-xl font-bold">إضافة منتج جديد</h3>
                <button id="close-product-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="mb-4">
                    <label for="product-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">التصنيف</label>
                    <select id="product-category" class="form-select" required>
                        <option value="">اختر التصنيف</option>
                        <option value="انشائي">انشائي</option>
                        <option value="واجهات خارجية">واجهات خارجية</option>
                        <option value="ديكوري">ديكوري</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="product-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">اسم المنتج</label>
                    <input type="text" id="product-name" class="form-input" required>
                </div>
                <div id="product-batches-container">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">الألوان/الباتشات</label>
                        <button type="button" id="add-batch-btn" class="text-primary-500 hover:text-primary-700 text-sm">
                            <i class="fas fa-plus ml-1"></i>
                            إضافة باتش
                        </button>
                    </div>
                    <div id="batches-list" class="space-y-3">
                        <div class="batch-item bg-gray-50 dark:bg-gray-700 p-3 rounded-md">
                            <div class="flex flex-col md:flex-row gap-3">
                                <div class="w-full md:w-1/2">
                                    <label for="batch-name-0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">اسم الباتش/اللون</label>
                                    <input type="text" id="batch-name-0" class="form-input batch-name" required>
                                </div>
                                <div class="w-full md:w-1/2">
                                    <label for="batch-price-0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">السعر</label>
                                    <input type="number" id="batch-price-0" class="form-input batch-price" min="0" step="0.01" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-6 space-x-3 space-x-reverse">
                    <button type="button" id="cancel-product-btn" class="btn btn-secondary">إلغاء</button>
                    <button type="submit" id="save-product-btn" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Client Modal -->
    <div id="client-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="client-modal-title" class="text-xl font-bold">إضافة عميل جديد</h3>
                <button id="close-client-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="client-form">
                <input type="hidden" id="client-id">
                <div class="mb-4">
                    <label for="client-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">اسم العميل</label>
                    <input type="text" id="client-name" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="client-phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">رقم الهاتف</label>
                    <input type="tel" id="client-phone" class="form-input" pattern="[0-9]+" required>
                </div>
                <div class="mb-4">
                    <label for="client-address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">العنوان</label>
                    <textarea id="client-address" class="form-input" rows="2"></textarea>
                </div>
                <div class="mb-4">
                    <label for="client-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">تصنيف العميل</label>
                    <select id="client-type" class="form-select" required>
                        <option value="">اختر التصنيف</option>
                        <option value="هيئات/مشاريع">هيئات/مشاريع</option>
                        <option value="محلات">محلات</option>
                        <option value="اهالى">اهالى</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="client-discount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">نسبة الخصم (%)</label>
                    <input type="number" id="client-discount" class="form-input" min="0" max="100" value="0">
                </div>
                <div class="flex justify-end mt-6 space-x-3 space-x-reverse">
                    <button type="button" id="cancel-client-btn" class="btn btn-secondary">إلغاء</button>
                    <button type="submit" id="save-client-btn" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Order Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="order-modal-title" class="text-xl font-bold">إنشاء طلب جديد</h3>
                <button id="close-order-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="order-form">
                <input type="hidden" id="order-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="order-client" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">العميل</label>
                        <select id="order-client" class="form-select" required>
                            <option value="">اختر العميل</option>
                            <!-- Clients will be loaded dynamically -->
                        </select>
                    </div>
                    <div>
                        <label for="order-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">التاريخ</label>
                        <input type="date" id="order-date" class="form-input" required>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">المنتجات</label>
                        <button type="button" id="add-order-item-btn" class="text-primary-500 hover:text-primary-700 text-sm">
                            <i class="fas fa-plus ml-1"></i>
                            إضافة منتج
                        </button>
                    </div>
                    
                    <div id="order-items-list" class="space-y-3">
                        <div class="order-item bg-gray-50 dark:bg-gray-700 p-3 rounded-md">
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                                <div class="md:col-span-2">
                                    <label for="order-product-0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">المنتج</label>
                                    <select id="order-product-0" class="form-select order-product" required>
                                        <option value="">اختر المنتج</option>
                                        <!-- Products will be loaded dynamically -->
                                    </select>
                                </div>
                                <div>
                                    <label for="order-batch-0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الباتش/اللون</label>
                                    <select id="order-batch-0" class="form-select order-batch" required disabled>
                                        <option value="">اختر الباتش</option>
                                        <!-- Batches will be loaded dynamically -->
                                    </select>
                                </div>
                                <div>
                                    <label for="order-quantity-0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الكمية</label>
                                    <input type="number" id="order-quantity-0" class="form-input order-quantity" min="1" value="1" required>
                                </div>
                                <div class="flex items-end">
                                    <button type="button" class="remove-order-item text-red-500 hover:text-red-700 mb-1 hidden">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="order-payment-method" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">طريقة الدفع</label>
                        <select id="order-payment-method" class="form-select" required>
                            <option value="">اختر طريقة الدفع</option>
                            <option value="cash">نقدي</option>
                            <option value="bank">تحويل بنكي</option>
                            <option value="vodafone-cash">فودافون كاش</option>
                            <option value="check">شيك</option>
                            <option value="credit">آجل</option>
                        </select>
                    </div>
                    <div>
                        <label for="order-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">حالة الطلب</label>
                        <select id="order-status" class="form-select" required>
                            <option value="pending">قيد الانتظار</option>
                            <option value="completed">مكتمل</option>
                            <option value="cancelled">ملغي</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="order-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ملاحظات</label>
                    <textarea id="order-notes" class="form-input" rows="2"></textarea>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="order-deposit-check" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded ml-2">
                        <label for="order-deposit-check" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                            إضافة عربون للطلب
                        </label>
                    </div>
                    
                    <div id="order-deposit-container" class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                        <div>
                            <label for="order-deposit-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">قيمة العربون</label>
                            <input type="number" id="order-deposit-amount" class="form-input" min="0">
                        </div>
                        <div>
                            <label for="order-deposit-method" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">طريقة دفع العربون</label>
                            <select id="order-deposit-method" class="form-select">
                                <option value="">اختر طريقة الدفع</option>
                                <option value="cash">نقدي</option>
                                <option value="bank">تحويل بنكي</option>
                                <option value="vodafone-cash">فودافون كاش</option>
                                <option value="check">شيك</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-md mb-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">الإجمالي قبل الخصم:</p>
                            <p id="order-subtotal" class="font-bold">0 ج.م</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">قيمة الخصم:</p>
                            <p id="order-discount-amount" class="font-bold">0 ج.م</p>
                            <p id="order-discount-percentage" class="text-sm text-gray-500 dark:text-gray-400">(0%)</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">قيمة العربون:</p>
                            <p id="order-deposit-display" class="font-bold">0 ج.م</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">الإجمالي النهائي:</p>
                            <p id="order-total" class="font-bold text-lg text-primary-600">0 ج.م</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 space-x-reverse">
                    <button type="button" id="cancel-order-btn" class="btn btn-secondary">إلغاء</button>
                    <button type="submit" id="save-order-btn" class="btn btn-primary">حفظ الطلب</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="payment-modal-title" class="text-xl font-bold">إضافة سداد جديد</h3>
                <button id="close-payment-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="payment-form">
                <input type="hidden" id="payment-id">
                <div class="mb-4">
                    <label for="payment-client" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">العميل</label>
                    <select id="payment-client" class="form-select" required>
                        <option value="">اختر العميل</option>
                        <!-- Clients will be loaded dynamically -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="payment-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">تاريخ السداد</label>
                    <input type="date" id="payment-date" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="payment-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">المبلغ</label>
                    <input type="number" id="payment-amount" class="form-input" min="0.01" step="0.01" required>
                </div>
                <div class="mb-4">
                    <label for="payment-method" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">طريقة السداد</label>
                    <select id="payment-method" class="form-select" required>
                        <option value="">اختر طريقة السداد</option>
                        <option value="cash">نقدي</option>
                        <option value="bank">تحويل بنكي</option>
                        <option value="vodafone-cash">فودافون كاش</option>
                        <option value="check">شيك</option>
                    </select>
                </div>
                <div id="payment-check-details" class="mb-4 hidden">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="payment-check-number" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">رقم الشيك</label>
                            <input type="text" id="payment-check-number" class="form-input">
                        </div>
                        <div>
                            <label for="payment-check-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">تاريخ الشيك</label>
                            <input type="date" id="payment-check-date" class="form-input">
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="payment-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ملاحظات</label>
                    <textarea id="payment-notes" class="form-input" rows="2"></textarea>
                </div>
                <div class="mb-4" id="client-balance-container">
                    <p class="text-sm text-gray-500 dark:text-gray-400">رصيد العميل الحالي:</p>
                    <p id="client-current-balance" class="font-bold text-lg">0 ج.م</p>
                </div>
                <div class="flex justify-end mt-6 space-x-3 space-x-reverse">
                    <button type="button" id="cancel-payment-btn" class="btn btn-secondary">إلغاء</button>
                    <button type="submit" id="save-payment-btn" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Return Modal -->
    <div id="return-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="return-modal-title" class="text-xl font-bold">إضافة مرتجع جديد</h3>
                <button id="close-return-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="return-form">
                <input type="hidden" id="return-id">
                <div class="mb-4">
                    <label for="return-client" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">العميل</label>
                    <select id="return-client" class="form-select" required>
                        <option value="">اختر العميل</option>
                        <!-- Clients will be loaded dynamically -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="return-order" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الطلب</label>
                    <select id="return-order" class="form-select" required disabled>
                        <option value="">اختر الطلب</option>
                        <!-- Orders will be loaded dynamically based on selected client -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="return-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">تاريخ المرتجع</label>
                    <input type="date" id="return-date" class="form-input" required>
                </div>
                
                <div id="return-items-container" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">المنتجات</label>
                    <div id="return-items-list" class="space-y-3">
                        <!-- Return items will be dynamically inserted here -->
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="return-reason" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">سبب المرتجع</label>
                    <textarea id="return-reason" class="form-input" rows="2" required></textarea>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-md mb-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">قيمة المرتجع:</p>
                            <p id="return-total" class="font-bold text-lg text-primary-600">0 ج.م</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end mt-6 space-x-3 space-x-reverse">
                    <button type="button" id="cancel-return-btn" class="btn btn-secondary">إلغاء</button>
                    <button type="submit" id="save-return-btn" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal (Admin only) -->
    <div id="user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="user-modal-title" class="text-xl font-bold">إضافة مستخدم جديد</h3>
                <button id="close-user-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="mb-4">
                    <label for="user-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الاسم</label>
                    <input type="text" id="user-name" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="user-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">البريد الإلكتروني</label>
                    <input type="email" id="user-email" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="user-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">كلمة المرور</label>
                    <input type="password" id="user-password" class="form-input" minlength="6">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">اترك هذا الحقل فارغًا إذا كنت لا تريد تغيير كلمة المرور الحالية.</p>
                </div>
                <div class="mb-4">
                    <label for="user-role" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الدور</label>
                    <select id="user-role" class="form-select" required>
                        <option value="">اختر الدور</option>
                        <option value="admin">مدير</option>
                        <option value="supervisor">مشرف</option>
                        <option value="user">مستخدم</option>
                    </select>
                </div>
                <div class="mb-4" id="user-permissions-container">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">الصلاحيات</label>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="checkbox" id="perm-view-dashboard" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded ml-2">
                            <label for="perm-view-dashboard" class="text-sm text-gray-700 dark:text-gray-300">
                                عرض لوحة التحكم
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="perm-manage-products" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded ml-2">
                            <label for="perm-manage-products" class="text-sm text-gray-700 dark:text-gray-300">
                                إدارة المنتجات
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="perm-manage-clients" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded ml-2">
                            <label for="perm-manage-clients" class="text-sm text-gray-700 dark:text-gray-300">
                                إدارة العملاء
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="perm-manage-orders" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded ml-2">
                            <label for="perm-manage-orders" class="text-sm text-gray-700 dark:text-gray-300">
                                إدارة الطلبات
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="perm-manage-invoices" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded ml-2">
                            <label for="perm-manage-invoices" class="text-sm text-gray-700 dark:text-gray-300">
                                إدارة الفواتير
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="perm-manage-payments" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded ml-2">
                            <label for="perm-manage-payments" class="text-sm text-gray-700 dark:text-gray-300">
                                إدارة المدفوعات
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="perm-manage-returns" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded ml-2">
                            <label for="perm-manage-returns" class="text-sm text-gray-700 dark:text-gray-300">
                                إدارة المرتجعات
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="perm-view-reports" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded ml-2">
                            <label for="perm-view-reports" class="text-sm text-gray-700 dark:text-gray-300">
                                عرض التقارير
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="user-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الحالة</label>
                    <select id="user-status" class="form-select" required>
                        <option value="active">نشط</option>
                        <option value="inactive">غير نشط</option>
                    </select>
                </div>
                <div class="flex justify-end mt-6 space-x-3 space-x-reverse">
                    <button type="button" id="cancel-user-btn" class="btn btn-secondary">إلغاء</button>
                    <button type="submit" id="save-user-btn" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invoice View Modal -->
    <div id="invoice-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">عرض الفاتورة</h3>
                <button id="close-invoice-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="invoice-content" class="print-container">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold">شركة الدهانات</h2>
                    <p>فاتورة ضريبية مبسطة</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">رقم الفاتورة:</p>
                        <p id="invoice-number" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">التاريخ:</p>
                        <p id="invoice-date" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">العميل:</p>
                        <p id="invoice-client" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">رقم الهاتف:</p>
                        <p id="invoice-phone" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">طريقة الدفع:</p>
                        <p id="invoice-payment-method" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">حالة الفاتورة:</p>
                        <p id="invoice-status" class="font-medium"></p>
                    </div>
                </div>
                
                <div class="mb-6">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">المنتج</th>
                                <th scope="col">الباتش/اللون</th>
                                <th scope="col">الكمية</th>
                                <th scope="col">سعر الوحدة</th>
                                <th scope="col">الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items">
                            <!-- Invoice items will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="col-start-2">
                        <div class="flex justify-between border-b border-gray-200 dark:border-gray-700 py-2">
                            <span>الإجمالي قبل الخصم:</span>
                            <span id="invoice-subtotal"></span>
                        </div>
                        <div class="flex justify-between border-b border-gray-200 dark:border-gray-700 py-2">
                            <span>الخصم (<span id="invoice-discount-percent"></span>%):</span>
                            <span id="invoice-discount"></span>
                        </div>
                        <div class="flex justify-between py-2 font-bold">
                            <span>الإجمالي النهائي:</span>
                            <span id="invoice-total"></span>
                        </div>
                        <div id="invoice-deposit-container" class="flex justify-between border-t border-gray-200 dark:border-gray-700 py-2">
                            <span>العربون المدفوع:</span>
                            <span id="invoice-deposit"></span>
                        </div>
                        <div id="invoice-remaining-container" class="flex justify-between border-t border-gray-200 dark:border-gray-700 py-2 font-bold">
                            <span>المبلغ المتبقي:</span>
                            <span id="invoice-remaining"></span>
                        </div>
                    </div>
                </div>
                
                <div id="invoice-notes-container" class="mb-6">
                    <p class="text-sm text-gray-500 dark:text-gray-400">ملاحظات:</p>
                    <p id="invoice-notes" class="border border-gray-200 dark:border-gray-700 p-2 rounded"></p>
                </div>
                
                <div class="text-center mt-8 mb-4">
                    <p>شكراً لتعاملكم معنا</p>
                </div>
            </div>
            
            <div class="flex justify-end mt-4 space-x-3 space-x-reverse">
                <button id="print-invoice-btn" class="btn btn-secondary">
                    <i class="fas fa-print ml-1"></i>
                    طباعة
                </button>
                <button id="download-invoice-btn" class="btn btn-primary">
                    <i class="fas fa-file-pdf ml-1"></i>
                    تصدير PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Order View Modal -->
    <div id="view-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">تفاصيل الطلب</h3>
                <button id="close-view-order-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="order-content">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">رقم الطلب:</p>
                        <p id="view-order-number" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">التاريخ:</p>
                        <p id="view-order-date" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">حالة الطلب:</p>
                        <p id="view-order-status" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">العميل:</p>
                        <p id="view-order-client" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">رقم الهاتف:</p>
                        <p id="view-order-phone" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">طريقة الدفع:</p>
                        <p id="view-order-payment-method" class="font-medium"></p>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-2">المنتجات</h4>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">المنتج</th>
                                    <th scope="col">الباتش/اللون</th>
                                    <th scope="col">الكمية</th>
                                    <th scope="col">سعر الوحدة</th>
                                    <th scope="col">الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody id="view-order-items">
                                <!-- Order items will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h4 class="text-lg font-semibold mb-2">ملاحظات</h4>
                        <div id="view-order-notes" class="border border-gray-200 dark:border-gray-700 p-4 rounded min-h-[100px]"></div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-2">ملخص الطلب</h4>
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-md">
                            <div class="flex justify-between border-b border-gray-200 dark:border-gray-700 py-2">
                                <span>الإجمالي قبل الخصم:</span>
                                <span id="view-order-subtotal"></span>
                            </div>
                            <div class="flex justify-between border-b border-gray-200 dark:border-gray-700 py-2">
                                <span>الخصم (<span id="view-order-discount-percent"></span>%):</span>
                                <span id="view-order-discount"></span>
                            </div>
                            <div class="flex justify-between py-2 font-bold">
                                <span>الإجمالي النهائي:</span>
                                <span id="view-order-total"></span>
                            </div>
                            <div id="view-order-deposit-container" class="flex justify-between border-t border-gray-200 dark:border-gray-700 py-2 hidden">
                                <span>العربون المدفوع:</span>
                                <span id="view-order-deposit"></span>
                            </div>
                            <div id="view-order-remaining-container" class="flex justify-between border-t border-gray-200 dark:border-gray-700 py-2 font-bold hidden">
                                <span>المبلغ المتبقي:</span>
                                <span id="view-order-remaining"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 space-x-reverse">
                    <button id="edit-viewed-order-btn" class="btn btn-secondary">
                        <i class="fas fa-edit ml-1"></i>
                        تعديل الطلب
                    </button>
                    <button id="create-invoice-from-order-btn" class="btn btn-primary">
                        <i class="fas fa-file-invoice-dollar ml-1"></i>
                        إنشاء فاتورة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyCpTjPsfaWTuNjpUupteqALjmb0qLUAzg8",
            authDomain: "delta-hcp.firebaseapp.com",
            projectId: "delta-hcp",
            storageBucket: "delta-hcp.firebasestorage.app",
            messagingSenderId: "956838180358",
            appId: "1:956838180358:web:af6abd7a430a8e17c83587",
            measurementId: "G-NJT5FCNJK3"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Global variables
        let currentUser = null;
        let activeTimeout = null;
        let products = [];
        let clients = [];
        let currentPage = 'dashboard';
        
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Toggle Dark Mode
        document.getElementById('theme-toggle').addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
        });
        
        // Format currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('ar-EG', { style: 'currency', currency: 'EGP' }).format(amount);
        };
        
        // Format date
        const formatDate = (date) => {
            if (!date) return '';
            if (typeof date === 'string') return date;
            
            const d = date instanceof Date ? date : date.toDate();
            return d.toISOString().split('T')[0];
        };
        
        // Convert timestamp to date
        const timestampToDate = (timestamp) => {
            if (!timestamp) return '';
            return timestamp instanceof Date ? timestamp : timestamp.toDate();
        };
        
        // Get today's date
        const getTodayDate = () => {
            const today = new Date();
            return today.toISOString().split('T')[0];
        };
        
        // User activity monitoring for auto-logout
        const resetActivityTimeout = () => {
            clearTimeout(activeTimeout);
            activeTimeout = setTimeout(autoLogout, 10 * 60 * 1000); // 10 minutes
        };
        
        const autoLogout = () => {
            Swal.fire({
                title: 'تم تسجيل الخروج تلقائياً',
                text: 'تم تسجيل خروجك تلقائياً بسبب عدم النشاط',
                icon: 'info',
                confirmButtonText: 'حسناً',
                confirmButtonColor: '#5D5CDE'
            }).then(() => {
                logout();
            });
        };
        
        // Add activity listeners
        ['click', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetActivityTimeout, true);
        });
        
        // Handle Login Form Submission
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            document.querySelector('#login-form button[type="submit"]').disabled = true;
            document.querySelector('#login-form button[type="submit"]').innerHTML = '<span class="loader inline-block w-5 h-5 border-2 border-t-2 border-white rounded-full"></span> جاري تسجيل الدخول...';
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Get the user's details from Firestore
                    db.collection('users').doc(userCredential.user.uid).get()
                        .then((doc) => {
                            if (doc.exists) {
                                const userData = doc.data();
                                currentUser = {
                                    uid: userCredential.user.uid,
                                    email: userCredential.user.email,
                                    name: userData.name,
                                    role: userData.role,
                                    permissions: userData.permissions || []
                                };
                                
                                // Check if user is active
                                if (userData.status === 'inactive') {
                                    auth.signOut();
                                    Swal.fire({
                                        title: 'حساب غير نشط',
                                        text: 'تم تعطيل هذا الحساب، يرجى التواصل مع المسؤول.',
                                        icon: 'error',
                                        confirmButtonText: 'حسناً',
                                        confirmButtonColor: '#5D5CDE'
                                    });
                                    document.querySelector('#login-form button[type="submit"]').disabled = false;
                                    document.querySelector('#login-form button[type="submit"]').innerHTML = 'تسجيل الدخول';
                                    return;
                                }
                                
                                // Initialize the app interface
                                initializeApp();
                            } else {
                                auth.signOut();
                                Swal.fire({
                                    title: 'خطأ في تسجيل الدخول',
                                    text: 'بيانات المستخدم غير متوفرة',
                                    icon: 'error',
                                    confirmButtonText: 'حسناً',
                                    confirmButtonColor: '#5D5CDE'
                                });
                                document.querySelector('#login-form button[type="submit"]').disabled = false;
                                document.querySelector('#login-form button[type="submit"]').innerHTML = 'تسجيل الدخول';
                            }
                        });
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    let errorMessage = 'حدث خطأ أثناء تسجيل الدخول';
                    if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        errorMessage = 'البريد الإلكتروني أو كلمة المرور غير صحيحة';
                    }
                    Swal.fire({
                        title: 'خطأ في تسجيل الدخول',
                        text: errorMessage,
                        icon: 'error',
                        confirmButtonText: 'حسناً',
                        confirmButtonColor: '#5D5CDE'
                    });
                    document.querySelector('#login-form button[type="submit"]').disabled = false;
                    document.querySelector('#login-form button[type="submit"]').innerHTML = 'تسجيل الدخول';
                });
        });
        
        // Initialize App after login
        const initializeApp = () => {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Set user name
            document.getElementById('user-name').textContent = currentUser.name;
            
            // Show/hide admin menu based on role
            if (currentUser.role === 'admin') {
                document.getElementById('admin-menu').classList.remove('hidden');
            } else {
                document.getElementById('admin-menu').classList.add('hidden');
            }
            
            // Apply permissions
            applyUserPermissions();
            
            // Load initial data
            loadDashboardData();
            loadProducts();
            loadClients();
            
            // Start activity monitoring
            resetActivityTimeout();
        };
        
        // Apply user permissions
        const applyUserPermissions = () => {
            // If admin, grant all permissions
            if (currentUser.role === 'admin') return;
            
            // For non-admin users, hide pages based on permissions
            const pages = {
                'dashboard': 'view_dashboard',
                'products': 'manage_products',
                'clients': 'manage_clients',
                'orders': 'manage_orders',
                'invoices': 'manage_invoices',
                'payments': 'manage_payments',
                'account-statement': 'view_statements',
                'returns': 'manage_returns',
                'reports': 'view_reports'
            };
            
            for (const [pageId, permission] of Object.entries(pages)) {
                const menuItem = document.querySelector(`.nav-link[data-page="${pageId}"]`).parentElement;
                
                if (currentUser.permissions && !currentUser.permissions.includes(permission)) {
                    menuItem.classList.add('hidden');
                }
            }
        };
        
        // Logout
        const logout = () => {
            auth.signOut().then(() => {
                currentUser = null;
                document.getElementById('app').classList.add('hidden');
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('login-form').reset();
                document.querySelector('#login-form button[type="submit"]').disabled = false;
                document.querySelector('#login-form button[type="submit"]').innerHTML = 'تسجيل الدخول';
                clearTimeout(activeTimeout);
            }).catch((error) => {
                console.error('Logout error:', error);
            });
        };
        
        document.getElementById('logout-button').addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
        
        // Toggle user dropdown
        document.getElementById('user-menu-button').addEventListener('click', () => {
            document.getElementById('user-dropdown').classList.toggle('hidden');
        });
        
        // Close user dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#user-menu-button') && !e.target.closest('#user-dropdown')) {
                document.getElementById('user-dropdown').classList.add('hidden');
            }
        });
        
        // Toggle sidebar on mobile
        document.getElementById('sidebar-toggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('hidden');
        });
        
        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.getAttribute('data-page');
                navigateTo(pageId);
            });
        });
        
        // Navigate to page
        const navigateTo = (pageId) => {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show the selected page
            document.getElementById(`${pageId}-page`).classList.remove('hidden');
            
            // Update active link in sidebar
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-primary-100', 'text-primary-800', 'dark:bg-primary-900', 'dark:text-primary-300');
            });
            document.querySelector(`.nav-link[data-page="${pageId}"]`).classList.add('bg-primary-100', 'text-primary-800', 'dark:bg-primary-900', 'dark:text-primary-300');
            
            // Close sidebar on mobile after navigation
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('hidden');
            }
            
            // Update current page
            currentPage = pageId;
            
            // Refresh page data if needed
            switch (pageId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'products':
                    loadProducts();
                    break;
                case 'clients':
                    loadClients();
                    break;
                case 'orders':
                    loadOrders();
                    break;
                case 'invoices':
                    loadInvoices();
                    break;
                case 'payments':
                    loadPayments();
                    break;
                case 'returns':
                    loadReturns();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'reports':
                    initializeReports();
                    break;
            }
        };
        
        // Format navigation links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.add('flex', 'items-center', 'py-2', 'px-4', 'text-gray-700', 'dark:text-gray-300', 'hover:bg-primary-50', 'hover:text-primary-600', 'dark:hover:bg-primary-900', 'dark:hover:text-primary-400', 'rounded-md', 'mb-1');
        });
        
        // Style the active link
        document.querySelector('.nav-link[data-page="dashboard"]').classList.add('bg-primary-100', 'text-primary-800', 'dark:bg-primary-900', 'dark:text-primary-300');
        
        // Load Dashboard Data
        const loadDashboardData = () => {
            // Fetch dashboard data from Firestore
            Promise.all([
                db.collection('orders').where('status', '!=', 'cancelled').get(),
                db.collection('clients').get(),
                db.collection('products').get()
            ]).then(([ordersSnapshot, clientsSnapshot, productsSnapshot]) => {
                // Update dashboard counters
                const totalOrders = ordersSnapshot.size;
                let totalSales = 0;
                
                ordersSnapshot.forEach(doc => {
                    const orderData = doc.data();
                    totalSales += orderData.total || 0;
                });
                
                document.getElementById('total-orders').textContent = totalOrders;
                document.getElementById('total-sales').textContent = formatCurrency(totalSales);
                document.getElementById('total-clients').textContent = clientsSnapshot.size;
                
                // Count unique products (including batches)
                let productCount = 0;
                productsSnapshot.forEach(doc => {
                    const productData = doc.data();
                    productCount += (productData.batches ? productData.batches.length : 0);
                });
                document.getElementById('total-products').textContent = productCount;
                
                // Initialize charts
                initializeSalesChart(ordersSnapshot.docs.map(doc => doc.data()));
                initializeProductsChart(ordersSnapshot.docs.map(doc => doc.data()));
            }).catch(error => {
                console.error('Error loading dashboard data:', error);
                Swal.fire({
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء تحميل بيانات لوحة التحكم',
                    icon: 'error',
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#5D5CDE'
                });
            });
        };
        
        // Initialize Sales Chart
        const initializeSalesChart = (orders) => {
            // Group orders by month
            const monthlyData = {};
            const now = new Date();
            
            // Create data for the last 6 months
            for (let i = 5; i >= 0; i--) {
                const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = `${month.getFullYear()}-${month.getMonth() + 1}`;
                monthlyData[monthKey] = { total: 0, count: 0 };
            }
            
            // Aggregate order data
            orders.forEach(order => {
                if (!order.date) return;
                
                const orderDate = timestampToDate(order.date);
                const monthKey = `${orderDate.getFullYear()}-${orderDate.getMonth() + 1}`;
                
                // Only include orders from the last 6 months
                if (monthlyData[monthKey]) {
                    monthlyData[monthKey].total += order.total || 0;
                    monthlyData[monthKey].count += 1;
                }
            });
            
            // Prepare chart data
            const months = Object.keys(monthlyData).sort();
            const totals = months.map(month => monthlyData[month].total);
            const counts = months.map(month => monthlyData[month].count);
            
            // Format month labels
            const monthNames = ['يناير', 'فبراير', 'مارس', 'إبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            const labels = months.map(month => {
                const [year, monthNum] = month.split('-');
                return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
            });
            
            // Create chart
            const ctx = document.getElementById('sales-chart').getContext('2d');
            
            if (window.salesChart) {
                window.salesChart.destroy();
            }
            
            window.salesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'المبيعات (ج.م)',
                            data: totals,
                            backgroundColor: 'rgba(93, 92, 222, 0.8)',
                            borderColor: 'rgba(93, 92, 222, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'عدد الطلبات',
                            data: counts,
                            backgroundColor: 'rgba(53, 162, 235, 0.8)',
                            borderColor: 'rgba(53, 162, 235, 1)',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'المبيعات (ج.م)'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'عدد الطلبات'
                            }
                        }
                    }
                }
            });
        };
        
        // Initialize Products Chart
        const initializeProductsChart = (orders) => {
            // Extract all order items
            const orderItems = [];
            orders.forEach(order => {
                if (order.items && Array.isArray(order.items)) {
                    orderItems.push(...order.items);
                }
            });
            
            // Group by product and sum quantities
            const productSales = {};
            orderItems.forEach(item => {
                const productKey = `${item.productName} - ${item.batchName}`;
                if (!productSales[productKey]) {
                    productSales[productKey] = {
                        productName: item.productName,
                        batchName: item.batchName,
                        quantity: 0,
                        total: 0
                    };
                }
                productSales[productKey].quantity += item.quantity || 0;
                productSales[productKey].total += (item.price * item.quantity) || 0;
            });
            
            // Sort products by sales total and get top 5
            const topProducts = Object.values(productSales)
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);
            
            // Prepare chart data
            const labels = topProducts.map(p => `${p.productName} - ${p.batchName}`);
            const data = topProducts.map(p => p.total);
            
            // Create chart
            const ctx = document.getElementById('products-chart').getContext('2d');
            
            if (window.productsChart) {
                window.productsChart.destroy();
            }
            
            window.productsChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'المبيعات',
                        data: data,
                        backgroundColor: [
                            'rgba(93, 92, 222, 0.8)',
                            'rgba(53, 162, 235, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 205, 86, 0.8)'
                        ],
                        borderColor: [
                            'rgba(93, 92, 222, 1)',
                            'rgba(53, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 205, 86, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const value = context.raw;
                                    const percentage = ((value * 100) / total).toFixed(1) + '%';
                                    return `${context.label}: ${formatCurrency(value)} (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
        };
        
        // Load Products
        const loadProducts = () => {
            db.collection('products').get().then((querySnapshot) => {
                products = [];
                querySnapshot.forEach((doc) => {
                    products.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                renderProductsTable(products);
                populateProductsDropdowns();
            }).catch((error) => {
                console.error('Error loading products:', error);
                Swal.fire({
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء تحميل المنتجات',
                    icon: 'error',
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#5D5CDE'
                });
            });
        };
        
        // Render Products Table
        const renderProductsTable = (productsData) => {
            const tableBody = document.getElementById('products-table-body');
            const emptyState = document.getElementById('products-empty-state');
            
            if (productsData.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            let html = '';
            productsData.forEach((product) => {
                if (product.batches && product.batches.length > 0) {
                    // First row for the first batch
                    const firstBatch = product.batches[0];
                    html += `
                        <tr>
                            <td>${product.id}</td>
                            <td>${product.name}</td>
                            <td>${product.category}</td>
                            <td>${firstBatch.name}</td>
                            <td>${formatCurrency(firstBatch.price)}</td>
                            <td>
                                <button class="edit-product-btn text-blue-600 hover:text-blue-800 ml-2" data-id="${product.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-product-btn text-red-600 hover:text-red-800" data-id="${product.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    
                    // Additional rows for other batches
                    if (product.batches.length > 1) {
                        for (let i = 1; i < product.batches.length; i++) {
                            const batch = product.batches[i];
                            html += `
                                <tr>
                                    <td>${product.id}</td>
                                    <td>${product.name}</td>
                                    <td>${product.category}</td>
                                    <td>${batch.name}</td>
                                    <td>${formatCurrency(batch.price)}</td>
                                    <td></td>
                                </tr>
                            `;
                        }
                    }
                } else {
                    html += `
                        <tr>
                            <td>${product.id}</td>
                            <td>${product.name}</td>
                            <td>${product.category}</td>
                            <td>-</td>
                            <td>-</td>
                            <td>
                                <button class="edit-product-btn text-blue-600 hover:text-blue-800 ml-2" data-id="${product.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-product-btn text-red-600 hover:text-red-800" data-id="${product.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }
            });
            
            tableBody.innerHTML = html;
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-product-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const productId = btn.getAttribute('data-id');
                    openProductModal(productId);
                });
            });
            
            document.querySelectorAll('.delete-product-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const productId = btn.getAttribute('data-id');
                    deleteProduct(productId);
                });
            });
        };
        
        // Populate Products Dropdowns
        const populateProductsDropdowns = () => {
            // Populate select in order form
            const orderProductSelect = document.getElementById('order-product-0');
            if (orderProductSelect) {
                let options = '<option value="">اختر المنتج</option>';
                products.forEach(product => {
                    options += `<option value="${product.id}">${product.name} (${product.category})</option>`;
                });
                orderProductSelect.innerHTML = options;
            }
        };
        
        // Product Modal
        const openProductModal = (productId = null) => {
            const modal = document.getElementById('product-modal');
            const modalTitle = document.getElementById('product-modal-title');
            const form = document.getElementById('product-form');
            const idInput = document.getElementById('product-id');
            const categoryInput = document.getElementById('product-category');
            const nameInput = document.getElementById('product-name');
            const batchesList = document.getElementById('batches-list');
            
            // Reset form
            form.reset();
            batchesList.innerHTML = `
                <div class="batch-item bg-gray-50 dark:bg-gray-700 p-3 rounded-md">
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="w-full md:w-1/2">
                            <label for="batch-name-0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">اسم الباتش/اللون</label>
                            <input type="text" id="batch-name-0" class="form-input batch-name" required>
                        </div>
                        <div class="w-full md:w-1/2">
                            <label for="batch-price-0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">السعر</label>
                            <input type="number" id="batch-price-0" class="form-input batch-price" min="0" step="0.01" required>
                        </div>
                    </div>
                </div>
            `;
            
            // Set modal title and populate fields if editing
            if (productId) {
                modalTitle.textContent = 'تعديل المنتج';
                const product = products.find(p => p.id === productId);
                if (product) {
                    idInput.value = product.id;
                    categoryInput.value = product.category;
                    nameInput.value = product.name;
                    
                    // Clear default batch item
                    batchesList.innerHTML = '';
                    
                    // Add existing batches
                    if (product.batches && product.batches.length > 0) {
                        product.batches.forEach((batch, index) => {
                            const batchItem = document.createElement('div');
                            batchItem.className = 'batch-item bg-gray-50 dark:bg-gray-700 p-3 rounded-md';
                            batchItem.innerHTML = `
                                <div class="flex flex-col md:flex-row gap-3">
                                    <div class="w-full md:w-1/2">
                                        <label for="batch-name-${index}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">اسم الباتش/اللون</label>
                                        <input type="text" id="batch-name-${index}" class="form-input batch-name" value="${batch.name}" required>
                                    </div>
                                    <div class="w-full md:w-1/2">
                                        <label for="batch-price-${index}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">السعر</label>
                                        <input type="number" id="batch-price-${index}" class="form-input batch-price" min="0" step="0.01" value="${batch.price}" required>
                                    </div>
                                </div>
                                ${index > 0 ? `
                                <div class="flex justify-end mt-2">
                                    <button type="button" class="remove-batch-btn text-red-500 hover:text-red-700 text-sm">
                                        <i class="fas fa-trash ml-1"></i>
                                        حذف الباتش
                                    </button>
                                </div>
                                ` : ''}
                            `;
                            batchesList.appendChild(batchItem);
                            
                            // Add event listener to remove button
                            if (index > 0) {
                                const removeBtn = batchItem.querySelector('.remove-batch-btn');
                                removeBtn.addEventListener('click', () => {
                                    batchItem.remove();
                                });
                            }
                        });
                    } else {
                        // If no batches, add a default empty one
                        const batchItem = document.createElement('div');
                        batchItem.className = 'batch-item bg-gray-50 dark:bg-gray-700 p-3 rounded-md';
                        batchItem.innerHTML = `
                            <div class="flex flex-col md:flex-row gap-3">
                                <div class="w-full md:w-1/2">
                                    <label for="batch-name-0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">اسم الباتش/اللون</label>
                                    <input type="text" id="batch-name-0" class="form-input batch-name" required>
                                </div>
                                <div class="w-full md:w-1/2">
                                    <label for="batch-price-0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">السعر</label>
                                    <input type="number" id="batch-price-0" class="form-input batch-price" min="0" step="0.01" required>
                                </div>
                            </div>
                        `;
                        batchesList.appendChild(batchItem);
                    }
                }
            } else {
                modalTitle.textContent = 'إضافة منتج جديد';
                idInput.value = '';
            }
            
            // Show modal
            modal.classList.remove('hidden');
        };
        
        // Add Batch
        document.getElementById('add-batch-btn').addEventListener('click', () => {
            const batchesList = document.getElementById('batches-list');
            const batchCount = batchesList.querySelectorAll('.batch-item').length;
            
            const batchItem = document.createElement('div');
            batchItem.className = 'batch-item bg-gray-50 dark:bg-gray-700 p-3 rounded-md';
            batchItem.innerHTML = `
                <div class="flex flex-col md:flex-row gap-3">
                    <div class="w-full md:w-1/2">
                        <label for="batch-name-${batchCount}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">اسم الباتش/اللون</label>
                        <input type="text" id="batch-name-${batchCount}" class="form-input batch-name" required>
                    </div>
                    <div class="w-full md:w-1/2">
                        <label for="batch-price-${batchCount}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">السعر</label>
                        <input type="number" id="batch-price-${batchCount}" class="form-input batch-price" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="flex justify-end mt-2">
                    <button type="button" class="remove-batch-btn text-red-500 hover:text-red-700 text-sm">
                        <i class="fas fa-trash ml-1"></i>
                        حذف الباتش
                    </button>
                </div>
            `;
            batchesList.appendChild(batchItem);
            
            // Add event listener to remove button
            const removeBtn = batchItem.querySelector('.remove-batch-btn');
            removeBtn.addEventListener('click', () => {
                batchItem.remove();
            });
        });
        
        // Close Product Modal
        document.getElementById('close-product-modal').addEventListener('click', () => {
            document.getElementById('product-modal').classList.add('hidden');
        });
        
        document.getElementById('cancel-product-btn').addEventListener('click', () => {
            document.getElementById('product-modal').classList.add('hidden');
        });
        
        // Add Product Button
        document.getElementById('add-product-btn').addEventListener('click', () => {
            openProductModal();
        });
        
        document.getElementById('empty-add-product-btn').addEventListener('click', () => {
            openProductModal();
        });
        
        // Save Product
        document.getElementById('product-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('product-id').value;
            const category = document.getElementById('product-category').value;
            const name = document.getElementById('product-name').value;
            
            // Get batches
            const batches = [];
            document.querySelectorAll('.batch-item').forEach((batchElement) => {
                const nameInput = batchElement.querySelector('.batch-name');
                const priceInput = batchElement.querySelector('.batch-price');
                
                if (nameInput && priceInput) {
                    batches.push({
                        name: nameInput.value,
                        price: parseFloat(priceInput.value)
                    });
                }
            });
            
            // Create product object
            const productData = {
                category,
                name,
                batches,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Save to Firestore
            let savePromise;
            if (productId) {
                // Update existing product
                savePromise = db.collection('products').doc(productId).update(productData);
            } else {
                // Add new product
                productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                savePromise = db.collection('products').add(productData);
            }
            
            savePromise.then(() => {
                document.getElementById('product-modal').classList.add('hidden');
                Swal.fire({
                    title: 'تم الحفظ',
                    text: productId ? 'تم تحديث المنتج بنجاح' : 'تم إضافة المنتج بنجاح',
                    icon: 'success',
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#5D5CDE'
                });
                loadProducts();
            }).catch((error) => {
                console.error('Error saving product:', error);
                Swal.fire({
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء حفظ المنتج',
                    icon: 'error',
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#5D5CDE'
                });
            });
        });
        
        // Delete Product
        const deleteProduct = (productId) => {
            Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا المنتج؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('products').doc(productId).delete()
                        .then(() => {
                            Swal.fire({
                                title: 'تم الحذف',
                                text: 'تم حذف المنتج بنجاح',
                                icon: 'success',
                                confirmButtonText: 'حسناً',
                                confirmButtonColor: '#5D5CDE'
                            });
                            loadProducts();
                        })
                        .catch((error) => {
                            console.error('Error deleting product:', error);
                            Swal.fire({
                                title: 'خطأ',
                                text: 'حدث خطأ أثناء حذف المنتج',
                                icon: 'error',
                                confirmButtonText: 'حسناً',
                                confirmButtonColor: '#5D5CDE'
                            });
                        });
                }
            });
        };
        
        // Product Search
        document.getElementById('product-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const categoryFilter = document.getElementById('product-category-filter').value;
            
            filterProducts(searchTerm, categoryFilter);
        });
        
        // Product Category Filter
        document.getElementById('product-category-filter').addEventListener('change', (e) => {
            const categoryFilter = e.target.value;
            const searchTerm = document.getElementById('product-search').value.toLowerCase();
            
            filterProducts(searchTerm, categoryFilter);
        });
        
        // Filter Products
        const filterProducts = (searchTerm, categoryFilter) => {
            let filteredProducts = products;
            
            // Filter by search term
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => {
                    return (
                        product.name.toLowerCase().includes(searchTerm) ||
                        product.category.toLowerCase().includes(searchTerm) ||
                        (product.batches && product.batches.some(batch => 
                            batch.name.toLowerCase().includes(searchTerm)
                        ))
                    );
                });
            }
            
            // Filter by category
            if (categoryFilter) {
                filteredProducts = filteredProducts.filter(product => 
                    product.category === categoryFilter
                );
            }
            
            renderProductsTable(filteredProducts);
        };
        
        // Load Clients
        const loadClients = () => {
            db.collection('clients').get().then((querySnapshot) => {
                clients = [];
                querySnapshot.forEach((doc) => {
                    clients.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                renderClientsTable(clients);
                populateClientsDropdowns();
            }).catch((error) => {
                console.error('Error loading clients:', error);
                Swal.fire({
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء تحميل العملاء',
                    icon: 'error',
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#5D5CDE'
                });
            });
        };
        
        // Render Clients Table
        const renderClientsTable = (clientsData) => {
            const tableBody = document.getElementById('clients-table-body');
            const emptyState = document.getElementById('clients-empty-state');
            
            if (clientsData.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            let html = '';
            clientsData.forEach((client) => {
                html += `
                    <tr>
                        <td>${client.id}</td>
                        <td>${client.name}</td>
                        <td>${client.phone || '-'}</td>
                        <td>${client.type || '-'}</td>
                        <td>${client.discount || 0}%</td>
                        <td>${formatCurrency(client.balance || 0)}</td>
                        <td>
                            <button class="edit-client-btn text-blue-600 hover:text-blue-800 ml-2" data-id="${client.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-client-btn text-red-600 hover:text-red-800" data-id="${client.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-client-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const clientId = btn.getAttribute('data-id');
                    openClientModal(clientId);
                });
            });
            
            document.querySelectorAll('.delete-client-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const clientId = btn.getAttribute('data-id');
                    deleteClient(clientId);
                });
            });
        };
        
        // Populate Clients Dropdowns
        const populateClientsDropdowns = () => {
            // Populate order client dropdown
            const orderClientSelect = document.getElementById('order-client');
            if (orderClientSelect) {
                let options = '<option value="">اختر العميل</option>';
                clients.forEach(client => {
                    options += `<option value="${client.id}">${client.name}</option>`;
                });
                orderClientSelect.innerHTML = options;
            }
            
            // Populate payment client dropdown
            const paymentClientSelect = document.getElementById('payment-client');
            if (paymentClientSelect) {
                let options = '<option value="">اختر العميل</option>';
                clients.forEach(client => {
                    options += `<option value="${client.id}">${client.name}</option>`;
                });
                paymentClientSelect.innerHTML = options;
            }
            
            // Populate return client dropdown
            const returnClientSelect = document.getElementById('return-client');
            if (returnClientSelect) {
                let options = '<option value="">اختر العميل</option>';
                clients.forEach(client => {
                    options += `<option value="${client.id}">${client.name}</option>`;
                });
                returnClientSelect.innerHTML = options;
            }
            
            // Populate statement client dropdown
            const statementClientSelect = document.getElementById('statement-client');
            if (statementClientSelect) {
                let options = '<option value="">اختر العميل</option>';
                clients.forEach(client => {
                    options += `<option value="${client.id}">${client.name}</option>`;
                });
                statementClientSelect.innerHTML = options;
            }
            
            // Populate payment client filter
            const paymentClientFilter = document.getElementById('payment-client-filter');
            if (paymentClientFilter) {
                let options = '<option value="">كل العملاء</option>';
                clients.forEach(client => {
                    options += `<option value="${client.id}">${client.name}</option>`;
                });
                paymentClientFilter.innerHTML = options;
            }
            
            // Populate return client filter
            const returnClientFilter = document.getElementById('return-client-filter');
            if (returnClientFilter) {
                let options = '<option value="">كل العملاء</option>';
                clients.forEach(client => {
                    options += `<option value="${client.id}">${client.name}</option>`;
                });
                returnClientFilter.innerHTML = options;
            }
        };
        
        // Client Modal
        const openClientModal = (clientId = null) => {
            const modal = document.getElementById('client-modal');
            const modalTitle = document.getElementById('client-modal-title');
            const form = document.getElementById('client-form');
            const idInput = document.getElementById('client-id');
            const nameInput = document.getElementById('client-name');
            const phoneInput = document.getElementById('client-phone');
            const addressInput = document.getElementById('client-address');
            const typeInput = document.getElementById('client-type');
            const discountInput = document.getElementById('client-discount');
            
            // Reset form
            form.reset();
            
            // Set modal title and populate fields if editing
            if (clientId) {
                modalTitle.textContent = 'تعديل العميل';
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    idInput.value = client.id;
                    nameInput.value = client.name;
                    phoneInput.value = client.phone || '';
                    addressInput.value = client.address || '';
                    typeInput.value = client.type || '';
                    discountInput.value = client.discount || 0;
                }
            } else {
                modalTitle.textContent = 'إضافة عميل جديد';
                idInput.value = '';
            }
            
            // Show modal
            modal.classList.remove('hidden');
        };
        
        // Close Client Modal
        document.getElementById('close-client-modal').addEventListener('click', () => {
            document.getElementById('client-modal').classList.add('hidden');
        });
        
        document.getElementById('cancel-client-btn').addEventListener('click', () => {
            document.getElementById('client-modal').classList.add('hidden');
        });
        
        // Add Client Button
        document.getElementById('add-client-btn').addEventListener('click', () => {
            openClientModal();
        });
        
        document.getElementById('empty-add-client-btn').addEventListener('click', () => {
            openClientModal();
        });
        
        // Save Client
        document.getElementById('client-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const clientId = document.getElementById('client-id').value;
            const name = document.getElementById('client-name').value;
            const phone = document.getElementById('client-phone').value;
            const address = document.getElementById('client-address').value;
            const type = document.getElementById('client-type').value;
            const discount = parseFloat(document.getElementById('client-discount').value) || 0;
            
            // Create client object
            const clientData = {
                name,
                phone,
                address,
                type,
                discount,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Save to Firestore
            let savePromise;
            if (clientId) {
                // Update existing client
                savePromise = db.collection('clients').doc(clientId).update(clientData);
            } else {
                // Add new client
                clientData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                clientData.balance = 0;
                savePromise = db.collection('clients').add(clientData);
            }
            
            savePromise.then(() => {
                document.getElementById('client-modal').classList.add('hidden');
                Swal.fire({
                    title: 'تم الحفظ',
                    text: clientId ? 'تم تحديث العميل بنجاح' : 'تم إضافة العميل بنجاح',
                    icon: 'success',
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#5D5CDE'
                });
                loadClients();
            }).catch((error) => {
                console.error('Error saving client:', error);
                Swal.fire({
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء حفظ العميل',
                    icon: 'error',
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#5D5CDE'
                });
            });
        });
        
        // Delete Client
        const deleteClient = (clientId) => {
            Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا العميل؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Check if client has orders
                    db.collection('orders').where('clientId', '==', clientId).get()
                        .then((ordersSnapshot) => {
                            if (!ordersSnapshot.empty) {
                                Swal.fire({
                                    title: 'لا يمكن الحذف',
                                    text: 'لا يمكن حذف هذا العميل لأنه مرتبط بطلبات موجودة.',
                                    icon: 'error',
                                    confirmButtonText: 'حسناً',
                                    confirmButtonColor: '#5D5CDE'
                                });
                                return;
                            }
                            
                            // Check if client has payments
                            db.collection('payments').where('clientId', '==', clientId).get()
                                .then((paymentsSnapshot) => {
                                    if (!paymentsSnapshot.empty) {
                                        Swal.fire({
                                            title: 'لا يمكن الحذف',
                                            text: 'لا يمكن حذف هذا العميل لأنه مرتبط بمدفوعات موجودة.',
                                            icon: 'error',
                                            confirmButtonText: 'حسناً',
                                            confirmButtonColor: '#5D5CDE'
                                        });
                                        return;
                                    }
                                    
                                    // Safe to delete
                                    db.collection('clients').doc(clientId).delete()
                                        .then(() => {
                                            Swal.fire({
                                                title: 'تم الحذف',
                                                text: 'تم حذف العميل بنجاح',
                                                icon: 'success',
                                                confirmButtonText: 'حسناً',
                                                confirmButtonColor: '#5D5CDE'
                                            });
                                            loadClients();
                                        })
                                        .catch((error) => {
                                            console.error('Error deleting client:', error);
                                            Swal.fire({
                                                title: 'خطأ',
                                                text: 'حدث خطأ أثناء حذف العميل',
                                                icon: 'error',
                                                confirmButtonText: 'حسناً',
                                                confirmButtonColor: '#5D5CDE'
                                            });
                                        });
                                });
                        });
                }
            });
        };
        
        // Client Search
        document.getElementById('client-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const typeFilter = document.getElementById('client-type-filter').value;
            
            filterClients(searchTerm, typeFilter);
        });
        
        // Client Type Filter
        document.getElementById('client-type-filter').addEventListener('change', (e) => {
            const typeFilter = e.target.value;
            const searchTerm = document.getElementById('client-search').value.toLowerCase();
            
            filterClients(searchTerm, typeFilter);
        });
        
        // Filter Clients
        const filterClients = (searchTerm, typeFilter) => {
            let filteredClients = clients;
            
            // Filter by search term
            if (searchTerm) {
                filteredClients = filteredClients.filter(client => {
                    return (
                        client.name.toLowerCase().includes(searchTerm) ||
                        (client.phone && client.phone.toLowerCase().includes(searchTerm)) ||
                        (client.address && client.address.toLowerCase().includes(searchTerm))
                    );
                });
            }
            
            // Filter by type
            if (typeFilter) {
                filteredClients = filteredClients.filter(client => 
                    client.type === typeFilter
                );
            }
            
            renderClientsTable(filteredClients);
        };
        
        // Load Orders
        const loadOrders = () => {
            db.collection('orders').orderBy('date', 'desc').get().then((querySnapshot) => {
                const orders = [];
                const clientPromises = [];
                
                querySnapshot.forEach((doc) => {
                    const orderData = doc.data();
                    orders.push({
                        id: doc.id,
                        ...orderData
                    });
                    
                    // Get client details if not already fetched
                    if (orderData.clientId && !clients.find(c => c.id === orderData.clientId)) {
                        clientPromises.push(
                            db.collection('clients').doc(orderData.clientId).get()
                                .then(clientDoc => {
                                    if (clientDoc.exists) {
                                        clients.push({
                                            id: clientDoc.id,
                                            ...clientDoc.data()
                                        });
                                    }
                                })
                        );
                    }
                });
                
                Promise.all(clientPromises).then(() => {
                    renderOrdersTable(orders);
                });
            }).catch((error) => {
                console.error('Error loading orders:', error);
                Swal.fire({
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء تحميل الطلبات',
                    icon: 'error',
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#5D5CDE'
                });
            });
        };
        
        // Render Orders Table
        const renderOrdersTable = (ordersData) => {
            const tableBody = document.getElementById('orders-table-body');
            const emptyState = document.getElementById('orders-empty-state');
            
            if (ordersData.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            let html = '';
            ordersData.forEach((order) => {
                const client = clients.find(c => c.id === order.clientId) || { name: 'غير معروف' };
                const orderDate = order.date ? formatDate(order.date) : '-';
                
                // Determine status class
                let statusClass = '';
                let statusText = '';
                switch (order.status) {
                    case 'pending':
                        statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300';
                        statusText = 'قيد الانتظار';
                        break;
                    case 'completed':
                        statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                        statusText = 'مكتمل';
                        break;
                    case 'cancelled':
                        statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                        statusText = 'ملغي';
                        break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300';
                        statusText = 'غير معروف';
                }
                
                // Determine payment method text
                let paymentMethodText = '';
                switch (order.paymentMethod) {
                    case 'cash':
                        paymentMethodText = 'نقدي';
                        break;
                    case 'bank':
                        paymentMethodText = 'تحويل بنكي';
                        break;
                    case 'vodafone-cash':
                        paymentMethodText = 'فودافون كاش';
                        break;
                    case 'check':
                        paymentMethodText = 'شيك';
                        break;
                    case 'credit':
                        paymentMethodText = 'آجل';
                        break;
                    default:
                        paymentMethodText = '-';
                }
                
                html += `
                    <tr>
                        <td>${order.id}</td>
                        <td>${orderDate}</td>
                        <td>${client.name}</td>
                        <td>${formatCurrency(order.total || 0)}</td>
                        <td>${paymentMethodText}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="view-order-btn text-gray-600 hover:text-gray-800 ml-2" data-id="${order.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="edit-order-btn text-blue-600 hover:text-blue-800 ml-2" data-id="${order.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-order-btn text-red-600 hover:text-red-800" data-id="${order.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
            // Add event listeners for buttons
            document.querySelectorAll('.view-order-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const orderId = btn.getAttribute('data-id');
                    viewOrder(orderId);
                });
            });
            
            document.querySelectorAll('.edit-order-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const orderId = btn.getAttribute('data-id');
                    openOrderModal(orderId);
                });
            });
            
            document.querySelectorAll('.delete-order-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const orderId = btn.getAttribute('data-id');
                    deleteOrder(orderId);
                });
            });
        };
        
        // Order Search
        document.getElementById('order-search').addEventListener('input', (e) => {
            filterOrders();
        });
        
        // Order Status Filter
        document.getElementById('order-status-filter').addEventListener('change', (e) => {
            filterOrders();
        });
        
        // Order Date Filters
        document.getElementById('order-date-from').addEventListener('change', (e) => {
            filterOrders();
        });
        
        document.getElementById('order-date-to').addEventListener('change', (e) => {
            filterOrders();
        });
        
        // Filter Orders
        const filterOrders = () => {
            const searchTerm = document.getElementById('order-search').value.toLowerCase();
            const statusFilter = document.getElementById('order-status-filter').value;
            const dateFromFilter = document.getElementById('order-date-from').value;
            const dateToFilter = document.getElementById('order-date-to').value;
            
            db.collection('orders').get().then((querySnapshot) => {
                const orders = [];
                querySnapshot.forEach((doc) => {
                    orders.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Apply filters
                let filteredOrders = orders;
                
                // Filter by search term
                if (searchTerm) {
                    filteredOrders = filteredOrders.filter(order => {
                        const client = clients.find(c => c.id === order.clientId) || { name: '' };
                        return (
                            order.id.toLowerCase().includes(searchTerm) ||
                            client.name.toLowerCase().includes(searchTerm)
                        );
                    });
                }
                
                // Filter by status
                if (statusFilter) {
                    filteredOrders = filteredOrders.filter(order => 
                        order.status === statusFilter
                    );
                }
                
                // Filter by date range
                if (dateFromFilter) {
                    const fromDate = new Date(dateFromFilter);
                    fromDate.setHours(0, 0, 0, 0);
                    filteredOrders = filteredOrders.filter(order => {
                        if (!order.date) return false;
                        const orderDate = timestampToDate(order.date);
                        return orderDate >= fromDate;
                    });
                }
                
                if (dateToFilter) {
                    const toDate = new Date(dateToFilter);
                    toDate.setHours(23, 59, 59, 999);
                    filteredOrders = filteredOrders.filter(order => {
                        if (!order.date) return false;
                        const orderDate = timestampToDate(order.date);
                        return orderDate <= toDate;
                    });
                }
                
                renderOrdersTable(filteredOrders);
            }).catch((error) => {
                console.error('Error filtering orders:', error);
            });
        };
        
        // Order Modal
        const openOrderModal = (orderId = null) => {
            const modal = document.getElementById('order-modal');
            const modalTitle = document.getElementById('order-modal-title');
            const form = document.getElementById('order-form');
            const idInput = document.getElementById('order-id');
            const clientSelect = document.getElementById('order-client');
            const dateInput = document.getElementById('order-date');
            const orderItemsList = document.getElementById('order-items-list');
            const paymentMethodSelect = document.getElementById('order-payment-method');
            const statusSelect = document.getElementById('order-status');
            const notesInput = document.getElementById('order-notes');
            const depositCheck = document.getElementById('order-deposit-check');
            const depositContainer = document.getElementById('order-deposit-container');
            const depositAmountInput = document.getElementById('order-deposit-amount');
            const depositMethodSelect = document.getElementById('order-deposit-method');
            
            // Reset form
            form.reset();
            orderItemsList.innerHTML = `
                <div class="order-item bg-gray-50 dark:bg-gray-700 p-3 rounded-md">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <div class="md:col-span-2">
                            <label for="order-product-0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">المنتج</label>
                            <select id="order-product-0" class="form-select order-product" required>
                                <option value="">اختر المنتج</option>
                                <!-- Products will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label for="order-batch-0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الباتش/اللون</label>
                            <select id="order-batch-0" class="form-select order-batch" required disabled>
                                <option value="">اختر الباتش</option>
                                <!-- Batches will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label for="order-quantity-0" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الكمية</label>
                            <input type="number" id="order-quantity-0" class="form-input order-quantity" min="1" value="1" required>
                        </div>
                        <div class="flex items-end">
                            <button type="button" class="remove-order-item text-red-500 hover:text-red-700 mb-1 hidden">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Set default date to today
            dateInput.value = getTodayDate();
            
            // Populate product dropdown
            const productSelect = document.getElementById('order-product-0');
            let productOptions = '<option value="">اختر المنتج</option>';
            products.forEach(product => {
                productOptions += `<option value="${product.id}">${product.name} (${product.category})</option>`;
            });
            productSelect.innerHTML = productOptions;
            
            // Add product change event
            productSelect.addEventListener('change', () => {
                updateProductBatches(productSelect);
                updateOrderTotal();
            });
            
            // Add quantity change event
            document.getElementById('order-quantity-0').addEventListener('input', updateOrderTotal);
            
            // Hide deposit fields
            depositContainer.classList.add('hidden');
            
            // Toggle deposit fields visibility
            depositCheck.addEventListener('change', () => {
                if (depositCheck.checked) {
                    depositContainer.classList.remove('hidden');
                } else {
                    depositContainer.classList.add('hidden');
                    depositAmountInput.value = '';
                    depositMethodSelect.value = '';
                }
                updateOrderTotal();
            });
            
            // Update deposit fields
            depositAmountInput.addEventListener('input', updateOrderTotal);
            
            // Set modal title and populate fields if editing
            if (orderId) {
                modalTitle.textContent = 'تعديل الطلب';
                
                db.collection('orders').doc(orderId).get().then((doc) => {
                    if (doc.exists) {
                        const order = {
                            id: doc.id,
                            ...doc.data()
                        };
                        
                        idInput.value = order.id;
                        clientSelect.value = order.clientId || '';
                        dateInput.value = formatDate(order.date);
                        paymentMethodSelect.value = order.paymentMethod || '';
                        statusSelect.value = order.status || 'pending';
                        notesInput.value = order.notes || '';
                        
                        // Clear order items list
                        orderItemsList.innerHTML = '';
                        
                        // Add each order item
                        if (order.items && order.items.length > 0) {
                            order.items.forEach((item, index) => {
                                addOrderItemToForm(index, item);
                            });
                        } else {
                            // Add a default empty item
                            addOrderItemToForm(0);
                        }
                        
                        // Set deposit if exists
                        if (order.deposit && order.deposit.amount > 0) {
                            depositCheck.checked = true;
                            depositContainer.classList.remove('hidden');
                            depositAmountInput.value = order.deposit.amount;
                            depositMethodSelect.value = order.deposit.method || '';
                        }
                        
                        // Update order total
                        updateOrderTotal();
                    }
                });
            } else {
                modalTitle.textContent = 'إنشاء طلب جديد';
                idInput.value = '';
                
                // Update total
                updateOrderTotal();
            }
            
            // Show modal
            modal.classList.remove('hidden');
        };
        
        // Add Order Item to Form
        const addOrderItemToForm = (index, item = null) => {
            const orderItemsList = document.getElementById('order-items-list');
            
            const orderItem = document.createElement('div');
            orderItem.className = 'order-item bg-gray-50 dark:bg-gray-700 p-3 rounded-md';
            orderItem.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                    <div class="md:col-span-2">
                        <label for="order-product-${index}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">المنتج</label>
                        <select id="order-product-${index}" class="form-select order-product" required>
                            <option value="">اختر المنتج</option>
                            <!-- Products will be loaded dynamically -->
                        </select>
                    </div>
                    <div>
                        <label for="order-batch-${index}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الباتش/اللون</label>
                        <select id="order-batch-${index}" class="form-select order-batch" required disabled>
                            <option value="">اختر الباتش</option>
                            <!-- Batches will be loaded dynamically -->
                        </select>
                    </div>
                    <div>
                        <label for="order-quantity-${index}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">الكمية</label>
                        <input type="number" id="order-quantity-${index}" class="form-input order-quantity" min="1" value="1" required>
                    </div>
                    <div class="flex items-end">
                        <button type="button" class="remove-order-item text-red-500 hover:text-red-700 mb-1 ${index === 0 ? 'hidden' : ''}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            orderItemsList.appendChild(orderItem);
            
            // Populate product dropdown
            const productSelect = document.getElementById(`order-product-${index}`);
            let productOptions = '<option value="">اختر المنتج</option>';
            products.forEach(product => {
                productOptions += `<option value="${product.id}">${product.name} (${product.category})</option>`;
            });
            productSelect.innerHTML = productOptions;
            
            // Set values if item is provided
            if (item) {
                productSelect.value = item.productId || '';
                
                // Populate batch dropdown and set its value
                if (item.productId) {
                    updateProductBatches(productSelect, item.batchName);
                }
                
                document.getElementById(`order-quantity-${index}`).value = item.quantity || 1;
            }
            
            // Add event listeners
            productSelect.addEventListener('change', () => {
                updateProductBatches(productSelect);
                updateOrderTotal();
            });
            
            document.getElementById(`order-quantity-${index}`).addEventListener('input', updateOrderTotal);
            
            // Add event listener to remove button
            const removeBtn = orderItem.querySelector('.remove-order-item');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => {
                    orderItem.remove();
                    updateOrderTotal();
                });
            }
        };
        
        // Update Product Batches Dropdown
        const updateProductBatches = (productSelect, selectedBatchName = null) => {
            const index = productSelect.id.replace('order-product-', '');
            const batchSelect = document.getElementById(`order-batch-${index}`);
            
            // Clear and disable batch select
            batchSelect.innerHTML = '<option value="">اختر الباتش</option>';
            batchSelect.disabled = true;
            
            // Get selected product
            const productId = productSelect.value;
            if (!productId) return;
            
            const product = products.find(p => p.id === productId);
            if (!product || !product.batches || product.batches.length === 0) return;
            
            // Populate batch select
            product.batches.forEach(batch => {
                const option = document.createElement('option');
                option.value = batch.name;
                option.textContent = `${batch.name} (${formatCurrency(batch.price)})`;
                option.dataset.price = batch.price;
                batchSelect.appendChild(option);
            });
            
            // Enable batch select
            batchSelect.disabled = false;
            
            // Set selected batch if provided
            if (selectedBatchName) {
                // Find the option with matching batch name
                const option = Array.from(batchSelect.options).find(opt => opt.value === selectedBatchName);
                if (option) {
                    batchSelect.value = selectedBatchName;
                }
            }
            
            // Add change event
            batchSelect.addEventListener('change', updateOrderTotal);
        };
        
        // Update Order Total
        const updateOrderTotal = () => {
            let subtotal = 0;
            
            // Get client discount
            const clientId = document.getElementById('order-client').value;
            let discountPercentage = 0;
            
            if (clientId) {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    discountPercentage = client.discount || 0;
                }
            }
            
            // Calculate subtotal from order items
            document.querySelectorAll('.order-item').forEach(item => {
                const productSelect = item.querySelector('.order-product');
                const batchSelect = item.querySelector('.order-batch');
                const quantityInput = item.querySelector('.order-quantity');
                
                if (productSelect.value && batchSelect.value && quantityInput.value) {
                    const selectedOption = batchSelect.options[batchSelect.selectedIndex];
                    if (selectedOption && selectedOption.dataset.price) {
                        const price = parseFloat(selectedOption.dataset.price);
                        const quantity = parseInt(quantityInput.value);
                        subtotal += price * quantity;
                    }
                }
            });
            
            // Calculate discount
            const discountAmount = (subtotal * discountPercentage) / 100;
            
            // Get deposit amount
            const depositCheck = document.getElementById('order-deposit-check');
            const depositAmountInput = document.getElementById('order-deposit-amount');
            let depositAmount = 0;
            
            if (depositCheck.checked && depositAmountInput.value) {
                depositAmount = parseFloat(depositAmountInput.value) || 0;
            }
            
            // Calculate total
            const total = subtotal - discountAmount;
            
            // Update display
            document.getElementById('order-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('order-discount-amount').textContent = formatCurrency(discountAmount);
            document.getElementById('order-discount-percentage').textContent = `(${discountPercentage}%)`;
            document.getElementById('order-deposit-display').textContent = formatCurrency(depositAmount);
            document.getElementById('order-total').textContent = formatCurrency(total);
        };
        
        // Add Order Item
        document.getElementById('add-order-item-btn').addEventListener('click', () => {
            const orderItemsList = document.getElementById('order-items-list');
            const orderItemCount = orderItemsList.querySelectorAll('.order-item').length;
            
            addOrderItemToForm(orderItemCount);
        });
        
        // Close Order Modal
        document.getElementById('close-order-modal').addEventListener('click', () => {
            document.getElementById('order-modal').classList.add('hidden');
        });
        
        document.getElementById('cancel-order-btn').addEventListener('click', () => {
            document.getElementById('order-modal').classList.add('hidden');
        });
        
        // Add Order Button
        document.getElementById('add-order-btn').addEventListener('click', () => {
            openOrderModal();
        });
        
        document.getElementById('empty-add-order-btn').addEventListener('click', () => {
            openOrderModal();
        });
        
        // Save Order
        document.getElementById('order-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const orderId = document.getElementById('order-id').value;
            const clientId = document.getElementById('order-client').value;
            const date = document.getElementById('order-date').value;
            const paymentMethod = document.getElementById('order-payment-method').value;
            const status = document.getElementById('order-status').value;
            const notes = document.getElementById('order-notes').value;
            
            // Get client discount
            let discountPercentage = 0;
            if (clientId) {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    discountPercentage = client.discount || 0;
                }
            }
            
            // Get order items
            const items = [];
            let subtotal = 0;
            
            document.querySelectorAll('.order-item').forEach(item => {
                const productSelect = item.querySelector('.order-product');
                const batchSelect = item.querySelector('.order-batch');
                const quantityInput = item.querySelector('.order-quantity');
                
                if (productSelect.value && batchSelect.value && quantityInput.value) {
                    const productId = productSelect.value;
                    const product = products.find(p => p.id === productId);
                    
                    const batchName = batchSelect.value;
                    const batch = product.batches.find(b => b.name === batchName);
                    
                    const price = batch.price;
                    const quantity = parseInt(quantityInput.value);
                    const total = price * quantity;
                    
                    subtotal += total;
                    
                    items.push({
                        productId,
                        productName: product.name,
                        category: product.category,
                        batchName,
                        price,
                        quantity,
                        total
                    });
                }
            });
            
            // Calculate discount
            const discountAmount = (subtotal * discountPercentage) / 100;
            
            // Get deposit
            const depositCheck = document.getElementById('order-deposit-check');
            const depositAmountInput = document.getElementById('order-deposit-amount');
            const depositMethodSelect = document.getElementById('order-deposit-method');
            let deposit = null;
            
            if (depositCheck.checked && depositAmountInput.value) {
                deposit = {
                    amount: parseFloat(depositAmountInput.value) || 0,
                    method: depositMethodSelect.value
                };
            }
            
            // Calculate total
            const total = subtotal - discountAmount;
            
            // Create order object
            const orderData = {
                clientId,
                date: new Date(date),
                items,
                subtotal,
                discountPercentage,
                discountAmount,
                total,
                paymentMethod,
                status,
                notes,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Add deposit if exists
            if (deposit) {
                orderData.deposit = deposit;
            }
            
            // Save to Firestore
            let savePromise;
            
            if (orderId) {
                // Update existing order
                savePromise = db.collection('orders').doc(orderId).update(orderData);
            } else {
                // Add new order
                orderData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                
                // Create a transaction to update client balance
                const batch = db.batch();
                
                // Add order
                const newOrderRef = db.collection('orders').doc();
                batch.set(newOrderRef, orderData);
                
                // Update client balance
                if (clientId && paymentMethod === 'credit') {
                    const clientRef = db.collection('clients').doc(clientId);
                    batch.update(clientRef, {
                        balance: firebase.firestore.FieldValue.increment(total),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                savePromise = batch.commit().then(() => {
                    return { id: newOrderRef.id };
                });
            }
            
            savePromise.then(() => {
                document.getElementById('order-modal').classList.add('hidden');
                Swal.fire({
                    title: 'تم الحفظ',
                    text: orderId ? 'تم تحديث الطلب بنجاح' : 'تم إنشاء الطلب بنجاح',
                    icon: 'success',
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#5D5CDE'
                });
                loadOrders();
            }).catch((error) => {
                console.error('Error saving order:', error);
                Swal.fire({
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء حفظ الطلب',
                    icon: 'error',
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#5D5CDE'
                });
            });
        });
        
        // View Order
        const viewOrder = (orderId) => {
            const modal = document.getElementById('view-order-modal');
            
            db.collection('orders').doc(orderId).get().then((doc) => {
                if (doc.exists) {
                    const order = {
                        id: doc.id,
                        ...doc.data()
                    };
                    
                    // Get client
                    const client = clients.find(c => c.id === order.clientId) || { name: 'غير معروف', phone: '-' };
                    
                    // Format payment method
                    let paymentMethodText = '';
                    switch (order.paymentMethod) {
                        case 'cash':
                            paymentMethodText = 'نقدي';
                            break;
                        case 'bank':
                            paymentMethodText = 'تحويل بنكي';
                            break;
                        case 'vodafone-cash':
                            paymentMethodText = 'فودافون كاش';
                            break;
                        case 'check':
                            paymentMethodText = 'شيك';
                            break;
                        case 'credit':
                            paymentMethodText = 'آجل';
                            break;
                        default:
                            paymentMethodText = '-';
                    }
                    
                    // Format status
                    let statusText = '';
                    let statusClass = '';
                    switch (order.status) {
                        case 'pending':
                            statusText = 'قيد الانتظار';
                            statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300';
                            break;
                        case 'completed':
                            statusText = 'مكتمل';
                            statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                            break;
                        case 'cancelled':
                            statusText = 'ملغي';
                            statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                            break;
                        default:
                            statusText = 'غير معروف';
                            statusClass = 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300';
                    }
                    
                    // Set order details
                    document.getElementById('view-order-number').textContent = order.id;
                    document.getElementById('view-order-date').textContent = formatDate(order.date);
                    document.getElementById('view-order-status').innerHTML = `<span class="badge ${statusClass}">${statusText}</span>`;
                    document.getElementById('view-order-client').textContent = client.name;
                    document.getElementById('view-order-phone').textContent = client.phone || '-';
                    document.getElementById('view-order-payment-method').textContent = paymentMethodText;
                    
                    // Set order notes
                    document.getElementById('view-order-notes').textContent = order.notes || 'لا توجد ملاحظات';
                    
                    // Set order items
                    const itemsContainer = document.getElementById('view-order-items');
                    itemsContainer.innerHTML = '';
                    
                    if (order.items && order.items.length > 0) {
                        order.items.forEach((item, index) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${item.productName} (${item.category})</td>
                                <td>${item.batchName}</td>
                                <td>${item.quantity}</td>
                                <td>${formatCurrency(item.price)}</td>
                                <td>${formatCurrency(item.total)}</td>
                            `;
                            itemsContainer.appendChild(row);
                        });
                    } else {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="6" class="text-center">لا توجد منتجات</td>
                        `;
                        itemsContainer.appendChild(row);
                    }
                    
                    // Set order summary
                    document.getElementById('view-order-subtotal').textContent = formatCurrency(order.subtotal || 0);
                    document.getElementById('view-order-discount-percent').textContent = order.discountPercentage || 0;
                    document.getElementById('view-order-discount').textContent = formatCurrency(order.discountAmount || 0);
                    document.getElementById('view-order-total').textContent = formatCurrency(order.total || 0);
                    
                    // Show/hide deposit info
                    if (order.deposit && order.deposit.amount > 0) {
                        document.getElementById('view-order-deposit-container').classList.remove('hidden');
                        document.getElementById('view-order-remaining-container').classList.remove('hidden');
                        document.getElementById('view-order-deposit').textContent = formatCurrency(order.deposit.amount);
                        document.getElementById('view-order-remaining').textContent = formatCurrency((order.total || 0) - order.deposit.amount);
                    } else {
                        document.getElementById('view-order-deposit-container').classList.add('hidden');
                        document.getElementById('view-order-remaining-container').classList.add('hidden');
                    }
                    
                    // Set button event handlers
                    document.getElementById('edit-viewed-order-btn').onclick = () => {
                        modal.classList.add('hidden');
                        openOrderModal(order.id);
                    };
                    
                    document.getElementById('create-invoice-from-order-btn').onclick = () => {
                        createInvoiceFromOrder(order);
                    };
                    
                    // Show modal
                    modal.classList.remove('hidden');
                }
            }).catch((error) => {
                console.error('Error loading order details:', error);
                Swal.fire({
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء تحميل تفاصيل الطلب',
                    icon: 'error',
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#5D5CDE'
                });
            });
        };
        
        // Close View Order Modal
        document.getElementById('close-view-order-modal').addEventListener('click', () => {
            document.getElementById('view-order-modal').classList.add('hidden');
        });
        
        // Delete Order
        const deleteOrder = (orderId) => {
            Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الطلب؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('orders').doc(orderId).get().then((doc) => {
                        if (doc.exists) {
                            const order = doc.data();
                            
                            // Create a batch to delete order and update client balance
                            const batch = db.batch();
                            
                            // Delete order
                            batch.delete(db.collection('orders').doc(orderId));
                            
                            // Update client balance if order was on credit
                            if (order.clientId && order.paymentMethod === 'credit' && order.status !== 'cancelled') {
                                batch.update(db.collection('clients').doc(order.clientId), {
                                    balance: firebase.firestore.FieldValue.increment(-order.total),
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                            
                            batch.commit().then(() => {
                                Swal.fire({
                                    title: 'تم الحذف',
                                    text: 'تم حذف الطلب بنجاح',
                                    icon: 'success',
                                    confirmButtonText: 'حسناً',
                                    confirmButtonColor: '#5D5CDE'
                                });
                                loadOrders();
                            }).catch((error) => {
                                console.error('Error deleting order:', error);
                                Swal.fire({
                                    title: 'خطأ',
                                    text: 'حدث خطأ أثناء حذف الطلب',
                                    icon: 'error',
                                    confirmButtonText: 'حسناً',
                                    confirmButtonColor: '#5D5CDE'
                                });
                            });
                        }
                    });
                }
            });
        };
        
        // Create Invoice from Order
        const createInvoiceFromOrder = (order) => {
            // Hide view order modal
            document.getElementById('view-order-modal').classList.add('hidden');
            
            // Get client
            const client = clients.find(c => c.id === order.clientId) || { name: 'غير معروف', phone: '-' };
            
            // Format payment method
            let paymentMethodText = '';
            switch (order.paymentMethod) {
                case 'cash':
                    paymentMethodText = 'نقدي';
                    break;
                case 'bank':
                    paymentMethodText = 'تحويل بنكي';
                    break;
                case 'vodafone-cash':
                    paymentMethodText = 'فودافون كاش';
                    break;
                case 'check':
                    paymentMethodText = 'شيك';
                    break;
                case 'credit':
                    paymentMethodText = 'آجل';
                    break;
                default:
                    paymentMethodText = '-';
            }
            
            // Format status
            let statusText = '';
            let statusClass = '';
            if (order.paymentMethod === 'credit') {
                statusText = 'غير مدفوع';
                statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
            } else {
                statusText = 'مدفوع';
                statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
            }
            
            // Set invoice details
            document.getElementById('invoice-number').textContent = 'INV-' + order.id;
            document.getElementById('invoice-date').textContent = formatDate(order.date);
            document.getElementById('invoice-client').textContent = client.name;
            document.getElementById('invoice-phone').textContent = client.phone || '-';
            document.getElementById('invoice-payment-method').textContent = paymentMethodText;
            document.getElementById('invoice-status').innerHTML = `<span class="badge ${statusClass}">${statusText}</span>`;
            
            // Set invoice items
            const itemsContainer = document.getElementById('invoice-items');
            itemsContainer.innerHTML = '';
            
            if (order.items && order.items.length > 0) {
                order.items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.productName} (${item.category})</td>
                        <td>${item.batchName}</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(item.price)}</td>
                        <td>${formatCurrency(item.total)}</td>
                    `;
                    itemsContainer.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="text-center">لا توجد منتجات</td>
                `;
                itemsContainer.appendChild(row);
            }
            
            // Set invoice summary
            document.getElementById('invoice-subtotal').textContent = formatCurrency(order.subtotal || 0);
            document.getElementById('invoice-discount-percent').textContent = order.discountPercentage || 0;
            document.getElementById('invoice-discount').textContent = formatCurrency(order.discountAmount || 0);
            document.getElementById('invoice-total').textContent = formatCurrency(order.total || 0);
            
            // Show/hide deposit info
            if (order.deposit && order.deposit.amount > 0) {
                document.getElementById('invoice-deposit-container').classList.remove('hidden');
                document.getElementById('invoice-remaining-container').classList.remove('hidden');
                document.getElementById('invoice-deposit').textContent = formatCurrency(order.deposit.amount);
                document.getElementById('invoice-remaining').textContent = formatCurrency((order.total || 0) - order.deposit.amount);
            } else {
                document.getElementById('invoice-deposit-container').classList.add('hidden');
                document.getElementById('invoice-remaining-container').classList.add('hidden');
            }
            
            // Set notes
            if (order.notes) {
                document.getElementById('invoice-notes-container').classList.remove('hidden');
                document.getElementById('invoice-notes').textContent = order.notes;
            } else {
                document.getElementById('invoice-notes-container').classList.add('hidden');
            }
            
            // Show invoice modal
            document.getElementById('invoice-modal').classList.remove('hidden');
        };
        
        // Close Invoice Modal
        document.getElementById('close-invoice-modal').addEventListener('click', () => {
            document.getElementById('invoice-modal').classList.add('hidden');
        });
        
        // Print Invoice
        document.getElementById('print-invoice-btn').addEventListener('click', () => {
            window.print();
        });
        
        // Download Invoice as PDF
        document.getElementById('download-invoice-btn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const content = document.getElementById('invoice-content');
            
            doc.setFont('Cairo');
            doc.text('شركة الدهانات - فاتورة', 105, 15, { align: 'center' });
            
            const clientName = document.getElementById('invoice-client').textContent;
            const invoiceNumber = document.getElementById('invoice-number').textContent;
            const invoiceDate = document.getElementById('invoice-date').textContent;
            
            doc.text(`رقم الفاتورة: ${invoiceNumber}`, 200, 30, { align: 'right' });
            doc.text(`التاريخ: ${invoiceDate}`, 200, 40, { align: 'right' });
            doc.text(`العميل: ${clientName}`, 200, 50, { align: 'right' });
            
            // Create table header
            const headers = [['#', 'المنتج', 'الباتش/اللون', 'الكمية', 'سعر الوحدة', 'الإجمالي']];
            
            // Get table data
            const data = [];
            document.querySelectorAll('#invoice-items tr').forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 6) {
                    data.push([
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[2].textContent,
                        cells[3].textContent,
                        cells[4].textContent,
                        cells[5].textContent
                    ]);
                }
            });
            
            // Create table
            doc.autoTable({
                head: headers,
                body: data,
                startY: 60,
                theme: 'grid',
                styles: {
                    font: 'Cairo',
                    halign: 'right'
                },
                headStyles: {
                    fillColor: [93, 92, 222]
                }
            });
            
            // Add summary
            const finalY = doc.lastAutoTable.finalY + 10;
            
            const subtotal = document.getElementById('invoice-subtotal').textContent;
            const discount = document.getElementById('invoice-discount').textContent;
            const total = document.getElementById('invoice-total').textContent;
            
            doc.text(`الإجمالي قبل الخصم: ${subtotal}`, 200, finalY, { align: 'right' });
            doc.text(`الخصم: ${discount}`, 200, finalY + 10, { align: 'right' });
            doc.text(`الإجمالي النهائي: ${total}`, 200, finalY + 20, { align: 'right' });
            
            // Check if deposit exists
            const depositContainer = document.getElementById('invoice-deposit-container');
            if (!depositContainer.classList.contains('hidden')) {
                const deposit = document.getElementById('invoice-deposit').textContent;
                const remaining = document.getElementById('invoice-remaining').textContent;
                
                doc.text(`العربون المدفوع: ${deposit}`, 200, finalY + 30, { align: 'right' });
                doc.text(`المبلغ المتبقي: ${remaining}`, 200, finalY + 40, { align: 'right' });
            }
            
            // Add notes if they exist
            const notesContainer = document.getElementById('invoice-notes-container');
            if (!notesContainer.classList.contains('hidden')) {
                const notes = document.getElementById('invoice-notes').textContent;
                const notesY = depositContainer.classList.contains('hidden') ? finalY + 30 : finalY + 50;
                
                doc.text('ملاحظات:', 200, notesY, { align: 'right' });
                doc.text(notes, 200, notesY + 10, { align: 'right', maxWidth: 180 });
            }
            
            // Add footer
            doc.text('شكراً لتعاملكم معنا', 105, 280, { align: 'center' });
            
            // Save PDF
            doc.save(`invoice-${invoiceNumber}.pdf`);
        });
        
        // Initialize any charts or components when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // Get the user's details from Firestore
                    db.collection('users').doc(user.uid).get()
                        .then((doc) => {
                            if (doc.exists) {
                                const userData = doc.data();
                                
                                // Check if user is active
                                if (userData.status === 'inactive') {
                                    auth.signOut();
                                    return;
                                }
                                
                                currentUser = {
                                    uid: user.uid,
                                    email: user.email,
                                    name: userData.name,
                                    role: userData.role,
                                    permissions: userData.permissions || []
                                };
                                
                                // Initialize the app interface
                                initializeApp();
                            } else {
                                auth.signOut();
                            }
                        });
                }
            });
        });
    </script>
</body>
</html>
